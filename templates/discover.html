<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discover - SKYTH</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-text-color: #e0e0e0;
            --secondary-text-color: #a0a0a0;
            --accent-color: #a7c7e7;
            --active-color: #a7c7e7;
            --border-color: #444;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --shadow-glow: 0 0 20px rgba(167, 199, 231, 0.2);
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        * {
            -webkit-tap-highlight-color: transparent;
        }

        #discover-page-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .discover-main-header {
            padding: 15px 20px;
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .discover-main-header h1 {
            font-size: 24px;
            margin: 0;
            color: var(--primary-text-color);
        }

        .back-to-chat-btn {
            background-color: var(--accent-color);
            color: #121212;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        .back-to-chat-btn:hover {
            background-color: #96b6d6;
        }

        .discover-nav-header {
            padding: 10px 15px;
            background: rgba(30, 30, 30, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 99;
        }
        .discover-nav-header::-webkit-scrollbar { display: none; }
        .discover-nav-header { -ms-overflow-style: none; scrollbar-width: none; }

        .nav-link {
            display: inline-block;
            padding: 8px 16px;
            margin: 0 5px;
            text-decoration: none;
            color: var(--secondary-text-color);
            background-color: transparent;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .nav-link.active, .nav-link:hover {
            background-color: var(--active-color);
            color: var(--bg-color);
        }

        .card-feed {
            padding: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            flex-grow: 1;
        }

        .card {
            background-color: rgba(30, 30, 30, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            opacity: 0;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-glow);
            border-color: var(--accent-color);
        }
        .card-thumbnail {
            width: 100%;
            height: 180px;
            object-fit: cover;
            transition: transform 0.4s ease;
        }
        .card:hover .card-thumbnail {
            transform: scale(1.05);
        }
        .card-content {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .card-content h2 {
            margin: 0 0 10px 0;
            font-size: 1.2rem;
            line-height: 1.4;
            color: var(--primary-text-color);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .card-content p {
            margin: 0 0 15px 0;
            color: var(--secondary-text-color);
            font-size: 0.9rem;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .card-source {
            margin-top: auto;
            padding-top: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            color: var(--secondary-text-color);
        }
        .center-message-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            grid-column: 1 / -1;
        }
        .loader {
            border: 5px solid var(--border-color);
            border-top: 5px solid var(--active-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .discover-article-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); z-index: 100;
            display: flex; flex-direction: column;
            transform: translateY(100%);
            visibility: hidden;
        }
        .discover-modal-header {
            padding: 10px 15px; display: flex; justify-content: flex-end;
            border-bottom: 1px solid var(--border-color); flex-shrink: 0;
        }
        .discover-modal-close-btn {
            font-size: 2rem; font-weight: bold; color: var(--secondary-text-color);
            cursor: pointer; background: none; border: none; line-height: 1;
        }
        .discover-modal-close-btn:hover { color: var(--primary-text-color); }
        .discover-modal-content-area { padding: 20px; overflow-y: auto; flex-grow: 1; max-width: 800px; margin: 0 auto; width: 100%; }
        .discover-modal-content-area img { max-width: 100%; height: auto; border-radius: 8px; margin-bottom: 20px; }
        .discover-modal-content-area h1 { font-size: 1.8rem; margin-bottom: 20px; color: var(--primary-text-color); }
        .discover-modal-content-area p { line-height: 1.7; font-size: 1.1rem; white-space: pre-wrap; color: var(--primary-text-color); }
        .discover-modal-content-area .error-text { white-space: pre-wrap; color: #ff4444; }
    </style>
</head>
<body>

    <div id="discover-page-container">
        <header class="discover-main-header">
            <h1>Discover</h1>
            <a href="/" class="back-to-chat-btn">Back to Chat</a>
        </header>
        <header class="discover-nav-header">
            <nav id="discover-category-nav"></nav>
        </header>
        <main id="discover-card-feed" class="card-feed"></main>
    </div>

    <div id="discover-article-modal" class="discover-article-modal">
        <div class="discover-modal-header">
            <button id="discover-modal-close-btn" class="discover-modal-close-btn">Ã—</button>
        </div>
        <div class="discover-modal-content-area"></div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const pageContainer = document.getElementById('discover-page-container');
    let currentDiscoverCategory = 'For You';

    const gebi = (id) => document.getElementById(id);
    const escapeHtml = (text) => {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    };

    function pageTransition(url) {
        anime({
            targets: pageContainer,
            opacity: [1, 0],
            scale: [1, 0.98],
            duration: 400,
            easing: 'easeInCubic',
            complete: () => {
                window.location.href = url;
            }
        });
    }

    function animatePageIn() {
        pageContainer.style.opacity = 0;
        anime({
            targets: pageContainer,
            opacity: [0, 1],
            scale: [0.98, 1],
            duration: 400,
            easing: 'easeOutCubic'
        });
    }

    function renderDiscoverNav() {
        const nav = gebi('discover-category-nav');
        const categories = ["For You", "Sports", "Entertainment", "Technology", "Top", "Around the World", "Science", "Business"];
        nav.innerHTML = categories.map(cat =>
            `<a class="nav-link ${cat === currentDiscoverCategory ? 'active' : ''}" data-category="${cat}">${cat}</a>`
        ).join('');
        nav.addEventListener('click', e => {
            if (e.target.classList.contains('nav-link')) {
                const category = e.target.dataset.category;
                if (category !== currentDiscoverCategory) {
                    currentDiscoverCategory = category;
                    nav.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
                    e.target.classList.add('active');
                    loadDiscoverCategory(category);
                }
            }
        });
    }

    async function loadDiscoverCategory(category) {
        const feed = gebi('discover-card-feed');
        feed.innerHTML = '<div class="center-message-container"><div class="loader"></div></div>';
        try {
            const response = await fetch(`/fetch_articles/${category}`);
            if (!response.ok) throw new Error('Network error');
            const articles = await response.json();
            renderDiscoverFeed(articles.filter(a => a.title && a.snippet && a.url));
        } catch (error) {
            console.error('Failed to load discover articles:', error);
            feed.innerHTML = '<div class="center-message-container"><p>Failed to load articles.</p></div>';
        }
    }

    function renderDiscoverFeed(articles) {
        const feed = gebi('discover-card-feed');
        feed.innerHTML = '';
        if (articles.length === 0) {
            feed.innerHTML = '<div class="center-message-container"><p>No articles found.</p></div>';
            return;
        }
        articles.forEach(article => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <img class="card-thumbnail" src="${article.thumbnail || 'https://via.placeholder.com/400x225/1e1e1e/888888?text=No+Image'}" alt="${escapeHtml(article.title)}" onError="this.onerror=null;this.src='https://via.placeholder.com/400x225/1e1e1e/888888?text=Image+Error';">
                <div class="card-content">
                    <h2>${escapeHtml(article.title)}</h2>
                    <p>${escapeHtml(article.snippet)}</p>
                    <span class="card-source">${escapeHtml(article.source || 'Unknown Source')}</span>
                </div>
            `;
            card.addEventListener('click', () => {
                fetch('/track_interaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category: article.category })
                }).catch(err => console.warn('Could not track interaction:', err));
                openDiscoverArticle(article);
            });
            feed.appendChild(card);
        });

        anime({
            targets: '#discover-card-feed .card',
            opacity: [0, 1],
            scale: [0.95, 1],
            translateY: [30, 0],
            delay: anime.stagger(70),
            duration: 600,
            easing: 'easeOutCubic'
        });
    }

    async function openDiscoverArticle(article) {
        const modal = gebi('discover-article-modal');
        modal.style.visibility = 'visible';
        document.body.style.overflow = 'hidden';
        anime({ targets: modal, translateY: ['100%', '0%'], easing: 'easeOutExpo', duration: 400 });

        const contentArea = modal.querySelector('.discover-modal-content-area');
        contentArea.innerHTML = '<div class="center-message-container"><div class="loader"></div></div>';
        
        try {
            const response = await fetch('/get_full_article', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: article.url })
            });
            const content = await response.json();
            contentArea.innerHTML = `
                ${content.image ? `<img src="${escapeHtml(content.image)}" alt="${escapeHtml(content.title)}">` : ''}
                <h1>${escapeHtml(content.title)}</h1>
                <p class="${!response.ok ? 'error-text' : ''}">${escapeHtml(content.text)}</p>
            `;
        } catch(error) {
             contentArea.innerHTML = `<h1>Error</h1><p class="error-text">Failed to load article content.</p>`;
        }
    }

    function closeDiscoverArticle() {
         const modal = gebi('discover-article-modal');
         anime({
            targets: modal,
            translateY: ['0%', '100%'],
            easing: 'easeInExpo',
            duration: 400,
            complete: () => {
                modal.style.visibility = 'hidden';
                modal.querySelector('.discover-modal-content-area').innerHTML = '';
                document.body.style.overflow = 'auto';
            }
        });
    }

    gebi('discover-modal-close-btn').addEventListener('click', closeDiscoverArticle);
    document.querySelector('.back-to-chat-btn').addEventListener('click', (e) => {
        e.preventDefault();
        pageTransition(e.currentTarget.href);
    });

    // Initial Load
    animatePageIn();
    renderDiscoverNav();
    loadDiscoverCategory(currentDiscoverCategory);
});
</script>

</body>
</html>