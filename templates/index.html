<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKYTH Engine - The Genesis Engine</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Animation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- NEW: Prism.js for Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        MathJax = {
          tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] },
          svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    
    <style>
        :root {
            --bg-primary: #0a0a0a; --bg-secondary: #111111; --bg-tertiary: #1a1a1a;
            --text-primary: #eaeaea; --text-secondary: #a0a0a0; --text-muted: #666666;
            --accent-primary: #00d4ff; --accent-secondary: #00ffaa;
            --accent-glow: rgba(0, 212, 255, 0.2);
            --border-color: #2a2a2a; --success: #00ff88; --warning: #ffaa00; --error: #ff4444;
            --radius: 30px; --radius-sm: 20px; --shadow: 0 8px 32px rgba(0,0,0,0.4);
            --shadow-glow: 0 0 20px var(--accent-glow);
            --gradient-primary: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            --logo-color-left: var(--accent-primary);
            --logo-color-right: var(--accent-secondary);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            -webkit-tap-highlight-color: transparent; /* Disable tap highlight on mobile */
        }

        body { 
            font-family: 'Inter', sans-serif; background: var(--bg-primary); 
            color: var(--text-primary); line-height: 1.6; overflow-x: hidden; min-height: 100vh; 
            display: flex; flex-direction: column; position: relative;
            transition: background-color 0.5s ease, color 0.5s ease;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        
        /* FIX: PREVENT BACKGROUND SCROLL WHEN MODAL IS OPEN */
        body.modal-open {
            overflow: hidden !important; /* Use !important to override other scroll settings */
        }

        #video-background { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: cover; z-index: -2; opacity: 0; transition: opacity 0.8s ease; }
        #video-background.active { opacity: 0.3; }

        #three-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; width: 100%; position: relative; z-index: 1; }

        /* Landing Page Styles */
        .landing-page {
            min-height: 100vh; display: flex; align-items: center; justify-content: center; text-align: center;
            background: radial-gradient(circle at 50% 50%, rgba(0, 212, 255, 0.1) 0%, transparent 60%);
        }
        .landing-container { max-width: 600px; padding: 40px; }
        .landing-logo {
            font-size: 64px; font-weight: 700; background: var(--gradient-primary);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            margin-bottom: 20px; opacity: 0; transform: translateY(30px);
        }
        .landing-subtitle { font-size: 20px; color: var(--text-secondary); margin-bottom: 40px; opacity: 0; transform: translateY(20px); }
        .landing-login-form {
            background: var(--bg-tertiary); padding: 30px; border-radius: var(--radius); border: 1px solid var(--border-color);
            backdrop-filter: blur(20px); opacity: 0; transform: translateY(20px);
        }
        .landing-input {
            width: 100%; padding: 16px 20px; font-size: 16px; background: var(--bg-secondary);
            border: 2px solid var(--border-color); border-radius: 999px; color: var(--text-primary);
            margin-bottom: 20px; transition: all 0.3s ease;
        }
        .landing-input:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 20px var(--accent-glow); }
        .landing-btn {
            width: 100%; padding: 16px; background: var(--accent-primary); border: none; border-radius: 999px;
            color: var(--bg-primary); font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s ease;
        }
        .landing-btn:hover { background: var(--accent-secondary); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3); }

        /* Main App Layout */
        .main-app { display: none; flex-direction: column; min-height: 100vh; }
        #main-content-wrapper { display: flex; flex-direction: column; flex-grow: 1; }
        
        /* Header Styles */
        .header { 
            position: sticky; top: 0; z-index: 100; background: rgba(10,10,10,0.85); backdrop-filter: blur(15px); 
            border-bottom: 1px solid var(--border-color); padding: 12px 0;
            transform: translateY(-100%); animation: slideDown 0.8s ease-out forwards;
        }
        @keyframes slideDown { to { transform: translateY(0); } }

        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .logo { 
            display: flex; align-items: center; gap: 12px; white-space: nowrap;
            opacity: 0; transform: scale(0.8);
            animation: logoAppear 1s ease-out 0.3s forwards;
            text-decoration: none; color: inherit;
            cursor: pointer;
        }
        .logo-text {
            font-size: 24px; font-weight: 700; background: var(--gradient-primary); -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; background-clip: text;
        }
        .logo-switch-icon {
            width: 24px; height: 24px; transform: rotate(-15deg);
            display: flex; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            border-radius: 5px; overflow: hidden;
        }
        .logo-switch-left { background-color: var(--logo-color-left); width: 50%; height: 100%; transition: background-color 0.5s ease; }
        .logo-switch-right { background-color: var(--logo-color-right); width: 50%; height: 100%; transition: background-color 0.5s ease; }

        @keyframes logoAppear { to { opacity: 1; transform: scale(1); } }
        
        .user-info { display: flex; align-items: center; gap: 10px; }
        .header-btn {
            background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color);
            padding: 6px 12px; border-radius: 999px; text-decoration: none; font-size: 13px; transition: all 0.3s ease; cursor: pointer;
        }
        #profile-btn, #controls-toggle-btn, #discover-btn {
            width: 38px; height: 38px; border-radius: 50%; padding: 0;
            display: flex; align-items: center; justify-content: center;
            background-size: cover; background-position: center;
        }
        .header-btn:hover { background: var(--accent-primary); color: var(--bg-primary); border-color: var(--accent-primary); }
        .header-btn i { font-size: 16px; transition: transform 0.3s ease-in-out; }
        .header-btn#controls-toggle-btn.open i { transform: rotate(180deg); }

        .header-controls-wrapper { 
            max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out; margin-top: 10px;
        }
        .header-controls-wrapper.open { max-height: 300px; }
        .controls-container { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; padding-top: 10px; }
        .persona-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .persona-btn { 
            background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color); 
            padding: 6px 12px; border-radius: 999px; cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            font-size: 13px; transform: translateY(10px); opacity: 0;
            animation: fadeInUpSimple 0.6s ease-out forwards;
        }
        @keyframes fadeInUpSimple { to { opacity: 1; transform: translateY(0); } }

        .persona-btn.active, .persona-btn:hover { 
            background: var(--accent-primary); color: var(--bg-primary); border-color: var(--accent-primary);
            box-shadow: var(--shadow-glow); transform: translateY(-2px) scale(1.05);
        }

        .god-mode-toggle { 
            display: flex; align-items: center; gap: 10px; cursor: pointer; 
            padding: 6px 12px; border-radius: var(--radius-sm); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(10px); opacity: 0;
            animation: fadeInUpSimple 0.6s ease-out 0.4s forwards;
        }
        .god-mode-toggle:hover { background: var(--bg-tertiary); transform: translateY(-2px); }

        .toggle-switch { position: relative; width: 44px; height: 22px; background: var(--border-color); border-radius: 11px; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .toggle-switch.active { background: var(--accent-primary); box-shadow: var(--shadow-glow); }
        .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; background: white; border-radius: 50%; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .toggle-switch.active::after { transform: translateX(22px); }

        .main { flex-grow: 1; padding: 20px 0 40px; display: flex; flex-direction: column; }
        .search-section { text-align: center; margin-bottom: 20px; flex-shrink: 0; }
        .search-title { 
            font-size: 40px; font-weight: 700; margin-bottom: 12px; 
            background: linear-gradient(135deg, var(--text-primary), var(--text-secondary)); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            opacity: 0; transform: translateY(30px);
            animation: titleAppear 1s ease-out 0.6s forwards;
        }
        @keyframes titleAppear { to { opacity: 1; transform: translateY(0); } }

        .search-subtitle { 
            font-size: 16px; color: var(--text-secondary); margin-bottom: 24px;
            opacity: 0; animation: fadeIn 0.8s ease-out 0.8s forwards;
        }
        .search-section .search-container { 
            position: relative; max-width: 700px; margin: 0 auto;
            opacity: 0; transform: scale(0.9); animation: scaleIn 0.8s ease-out 1s forwards;
            display: flex; gap: 10px; align-items: center;
        }
        @keyframes scaleIn { to { opacity: 1; transform: scale(1); } }

        .search-input { 
            width: 100%; padding: 14px 20px; font-size: 16px; background: var(--bg-tertiary); 
            border: 2px solid var(--border-color); border-radius: 999px; color: var(--text-primary); 
            outline: none; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); flex-grow: 1;
        }
        .search-input:focus { border-color: var(--accent-primary); box-shadow: var(--shadow-glow); transform: translateY(-2px); }
        .search-input::placeholder { color: var(--text-muted); }

        .search-button { 
            background: var(--accent-primary); border: none; padding: 7px 14px;
            color: var(--bg-primary); font-weight: 600; cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-size: 14px;
            flex-shrink: 0; border-radius: 999px;
        }
        #initial-search-button {
            width: 50px; height: 50px; border-radius: 50%; padding: 0;
            font-size: 16px; display: flex; align-items: center; justify-content: center;
        }
        .search-button:hover { background: var(--accent-secondary); transform: scale(1.1) rotate(2deg); box-shadow: var(--shadow-glow); }
        #initial-search-button:hover { transform: scale(1.1); /* Override hover to remove rotate */ }
        .search-button:disabled { opacity: 0.5; cursor: not-allowed; transform: scale(1); background: var(--bg-tertiary) !important; color: var(--text-muted) !important;}
        
        #popular-topics-section {
            opacity: 0; transform: translateY(20px);
            animation: fadeInUpSimple 0.8s ease-out 1.2s forwards;
        }
        
        .topic-chip {
            background: var(--bg-secondary); color: var(--text-secondary); padding: 8px 16px;
            border-radius: 999px; font-size: 14px; cursor: pointer; transition: all 0.3s ease;
            border: 1px solid var(--border-color); text-align: left; display: inline-block; font-weight: 500;
        }
        .topic-chip:hover {
            background: var(--accent-primary); color: var(--bg-primary); border-color: var(--accent-primary);
            transform: translateY(-2px); box-shadow: var(--shadow-glow);
        }

        .thinking-display {
            background: var(--bg-secondary); border-radius: var(--radius-sm); padding: 15px 20px;
            border: 1px solid var(--border-color); position: relative; overflow: hidden;
            margin-bottom: 15px; display: none;
        }
        .thinking-display.active { display: block; animation: slideInUp 0.5s ease; }
        .thinking-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; color: var(--accent-primary); font-weight: 600; font-size: 14px; }
        .thinking-steps { display: flex; flex-direction: column; gap: 8px; }
        .thinking-step {
            display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: var(--bg-tertiary);
            border-radius: var(--radius-sm); font-size: 13px; opacity: 0; transform: translateX(-20px);
            transition: all 0.4s ease; border-left: 3px solid transparent;
        }
        .thinking-step.active { opacity: 1; transform: translateX(0); border-left-color: var(--accent-primary); }
        .thinking-step.completed { opacity: 0.7; border-left-color: var(--success); }
        .thinking-icon { color: var(--accent-primary); animation: spin 1s linear infinite; }
        .thinking-step.completed .thinking-icon { color: var(--success); animation: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .conversation { max-width: 800px; margin: 0 auto; padding-bottom: 100px; /* Space for sticky input bar */ }
        .message { margin-bottom: 28px; opacity: 0; transform: translateY(20px) scale(0.98); }
        .message.animate-in { animation: messageAppear 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        @keyframes messageAppear { to { opacity: 1; transform: translateY(0) scale(1); } }
        
        .message-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .message-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); background-size: cover; background-position: center; border: 1px solid var(--border-color); flex-shrink: 0; }
        .message-avatar:hover { transform: scale(1.1) rotate(5deg); box-shadow: var(--shadow-glow); }
        .user-avatar { background-color: var(--accent-primary); color: var(--bg-primary); }
        .ai-avatar { background: transparent; }

        .message-content { 
            background: var(--bg-tertiary); border-radius: var(--radius); padding: 20px;
            border: 1px solid var(--border-color); position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .message-content:hover { border-color: var(--accent-primary); box-shadow: var(--shadow-glow); transform: translateY(-2px); }
        
        /* FIX: Ensure message content can be empty without collapsing */
        .message-content:empty {
            display: none;
        }

        .message-text { line-height: 1.7; white-space: pre-wrap; word-wrap: break-word; user-select: none; }
        .message-text pre, .message-text code { user-select: text; }
        .message-text h1,.message-text h2,.message-text h3 { color: var(--text-primary); margin: 16px 0 8px 0; }
        .message-text code:not(pre code) { background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px; font-family: 'Monaco','Menlo',monospace; color: var(--accent-primary); font-size: 0.9em; transition: all 0.2s ease;}
        /* PRE is handled by JS for artifacts or themed blocks */
        .message-text pre { display: block; } /* Changed from none to block */
        .message-text sup { font-size: 0.7em; vertical-align: super; line-height: 0; }
        
        .message-content .message-actions-bottom { position: absolute; bottom: 8px; right: 8px; display: flex; gap: 8px; z-index: 1; opacity: 0; transform: translateY(10px); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);}
        .message-content:hover .message-actions-bottom { opacity: 1; transform: translateY(0); }
        .message-content .copy-message-btn { background: var(--bg-primary); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 999px; padding: 5px 8px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-size: 12px; line-height: 1; }
        .message-content .copy-message-btn:hover { background: var(--accent-primary); color: var(--bg-primary); border-color: var(--accent-primary); transform: translateY(-2px) scale(1.1); box-shadow: var(--shadow-glow); }
        
        details { margin-top: 15px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-secondary); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        details summary { padding: 10px 15px; font-weight: 600; color: var(--text-secondary); cursor: pointer; list-style: none; display: flex; align-items: center; }
        details summary::-webkit-details-marker { display: none; } 
        details summary::before { content: '▶'; font-size: 0.8em; margin-right: 8px; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        details[open] summary::before { transform: rotate(90deg); }
        .details-content { padding: 0 15px 15px 15px; border-top: 1px solid var(--border-color); animation: detailsExpand 0.3s ease-out; }
        @keyframes detailsExpand { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .source-links { display: flex; flex-wrap: wrap; gap: 8px; padding-top: 10px; }
        .image-results-grid, .video-results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        .media-item { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 8px; text-align: center; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; transform: translateY(20px) scale(0.9); animation: imageItemAppear 0.6s ease-out forwards; text-decoration: none; color: var(--text-primary); cursor: pointer; }
        @keyframes imageItemAppear { from { opacity: 0; transform: translateY(20px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .media-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-glow); border-color: var(--accent-primary); }
        .media-item img { width: 100%; height: 100px; object-fit: cover; border-radius: var(--radius-sm); margin-bottom: 5px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .media-item-title { font-size: 12px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; height: 2.4em; }
        
        .suggestions { margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .suggestions-title { font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; }
        .suggestion-items { display: flex; flex-wrap: wrap; gap: 8px; }
        .suggestion-item { background: var(--bg-secondary); color: var(--text-secondary); padding: 8px 12px; border-radius: 999px; font-size: 12px; cursor: pointer; transition: all 0.3s ease; border: 1px solid var(--border-color); }
        .suggestion-item:hover { background: var(--accent-primary); color: var(--bg-primary); border-color: var(--accent-primary); transform: translateY(-2px); box-shadow: var(--shadow-glow); }

        .media-actions { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; flex-wrap: wrap; }
        .media-action-btn { background: var(--bg-secondary); color: var(--text-secondary); padding: 8px 12px; border-radius: 999px; font-size: 12px; cursor: pointer; transition: all 0.3s ease; border: 1px solid var(--border-color); }
        .media-action-btn:hover { background: var(--accent-primary); color: var(--bg-primary); border-color: var(--accent-primary); transform: translateY(-2px); box-shadow: var(--shadow-glow); }
        .media-action-btn i { margin-right: 6px; }
        
        /* STICKY INPUT BAR & CHATBOX (GROK-STYLE) */
        .sticky-input-bar {
            position: sticky; /* Changed to sticky */
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid var(--border-color);
            padding: 8px 0;
            margin-top: auto;
            z-index: 1000;
            display: none;
        }
        
        .multimodal-input-container {
            position: relative;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 28px;
            padding: 6px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .multimodal-input-container:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 15px var(--accent-glow);
        }

        #chat-input {
            flex-grow: 1;
            background: transparent;
            border: none;
            outline: none;
            box-shadow: none;
            resize: none;
            overflow-y: hidden;
            min-height: 30px;
            max-height: 200px;
            line-height: 1.5;
            font-size: 16px;
            padding: 10px;
            color: var(--text-primary);
        }
        
        #chat-input::placeholder { color: var(--text-muted); }
        
        .multimodal-toggle {
            position: relative;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
            border: none;
        }
        /* Multimodal toggle + to x animation */
        .multimodal-toggle i {
            transition: transform 0.3s ease-in-out;
        }
        .multimodal-toggle.active i {
            transform: rotate(45deg);
        }

        .multimodal-toggle:hover {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }
        
        .sticky-input-bar .search-button {
            position: static;
            transform: none;
            flex-shrink: 0;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            padding: 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent-primary);
            color: var(--bg-primary);
            border: none;
        }
        
        .sticky-input-bar .search-button:hover {
            background: var(--accent-secondary);
            transform: scale(1.05);
        }
        .sticky-input-bar .search-button:active { transform: scale(0.95); }
        .sticky-input-bar .search-button:disabled {
            background: var(--bg-secondary) !important;
            color: var(--text-muted) !important;
            transform: scale(1);
            cursor: not-allowed;
        }

        .multimodal-menu {
            position: absolute;
            bottom: 60px; /* Position above the new taller bar */
            left: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 8px;
            display: none;
            flex-direction: column;
            gap: 8px;
            min-width: 200px;
            box-shadow: var(--shadow);
            z-index: 1000;
        }
        
        .multimodal-menu.active { display: flex; animation: slideInUp 0.3s ease; }
        
        .multimodal-option {
            display: flex; align-items: center; gap: 12px; padding: 10px 12px;
            background: var(--bg-tertiary); border: 1px solid var(--border-color);
            border-radius: var(--radius-sm); cursor: pointer; transition: all 0.3s ease;
            color: var(--text-primary); text-decoration: none;
        }
        
        .multimodal-option:hover {
            background: var(--accent-primary); color: var(--bg-primary); border-color: var(--accent-primary);
            transform: translateY(-2px);
        }
        
        .multimodal-option i { font-size: 16px; width: 20px; text-align: center; }
        .multimodal-option span { font-size: 14px; font-weight: 500; }

        /* Image & File Preview in Input Bar */
        #image-preview-container, #file-preview-container {
            position: absolute; bottom: 100%; left: 0;
            margin-bottom: 10px; padding: 8px 12px;
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: var(--radius-sm); box-shadow: var(--shadow);
            display: none; align-items: center; gap: 10px;
            animation: slideInUp 0.3s ease;
            max-width: 90%;
        }
        #image-preview-thumbnail {
            width: 40px; height: 40px; object-fit: cover;
            border-radius: calc(var(--radius-sm) - 8px);
        }
        #file-preview-icon {
            font-size: 24px; color: var(--text-secondary);
        }
        #file-preview-name {
            font-size: 14px; color: var(--text-primary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        #remove-image-btn, #remove-file-btn {
            position: absolute; top: -8px; right: -8px;
            background: var(--error); color: white;
            width: 20px; height: 20px; border-radius: 50%;
            border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
        }

        .status-bar { position: fixed; bottom: 15px; right: 15px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 10px 14px; font-size: 13px; color: var(--text-secondary); backdrop-filter: blur(10px); opacity: 0; transform: translateY(15px); transition: all 0.3s ease; z-index: 2000; }
        .status-bar.active { opacity: 1; transform: translateY(0); }
        .status-bar.success { color: var(--success); } .status-bar.info { color: var(--accent-primary); } .status-bar.error { color: var(--error); }

        .particle { position: absolute; width: 4px; height: 4px; background: var(--accent-primary); border-radius: 50%; pointer-events: none; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; } 50% { transform: translateY(-20px) rotate(180deg); opacity: 1; } }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        @media (max-width: 768px) {
            .search-title { font-size: 28px; } .search-subtitle { font-size: 14px; }
            .container { padding: 0 12px; } .message-content { padding: 14px; }
            .image-results-grid, .video-results-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
            .logo-text { font-size: 20px; }
            .multimodal-menu { min-width: 180px; }
            /* Mobile specific: ensure sticky bar is always on top */
            .sticky-input-bar { position: fixed; } 
        }
        
        button { position: relative; overflow: hidden; }
        .ripple { position: absolute; border-radius: 50%; background: rgba(0, 212, 255, 0.3); pointer-events: none; transform: scale(0); animation: ripple 600ms linear; }
        @keyframes ripple { to { transform: scale(4); opacity: 0; } }

        /* Generic Modal Styles */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.85); z-index: 2000;
            justify-content: center; align-items: center; padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        .modal-box {
            background-color: var(--bg-secondary); padding: 25px; border-radius: var(--radius);
            width: 90%; max-width: 600px; max-height: 85vh; display: flex; flex-direction: column;
            position: relative; border: 1px solid var(--border-color); box-shadow: var(--shadow);
            animation: zoomIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-close-btn {
            position: absolute; top: 12px; right: 15px; background: var(--bg-tertiary);
            border: 1px solid var(--border-color); color: var(--text-primary);
            font-size: 18px; cursor: pointer; width:30px; height:30px; border-radius:50%;
            display:flex; align-items:center; justify-content:center;
        }
        .modal-header { color: var(--text-primary); margin-bottom: 20px; font-weight:600; font-size: 20px; }
        .modal-content { flex-grow: 1; overflow-y: auto; padding-right: 10px; }
        .modal-content::-webkit-scrollbar { width: 6px; }
        .modal-content::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }

        /* Settings Modal Specifics */
        .settings-section { margin-bottom: 25px; }
        .settings-label { display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px; font-weight: 500; }
        .settings-input, .settings-textarea { width: 100%; padding: 10px 14px; font-size: 14px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); color: var(--text-primary); }
        .settings-textarea { resize: vertical; min-height: 80px; }
        .pfp-upload-container { display: flex; align-items: center; gap: 15px; }
        #pfp-preview { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background: var(--bg-tertiary); border: 2px solid var(--border-color); cursor: pointer; }
        .settings-btn-sm { padding: 8px 12px; font-size: 13px; background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 999px; cursor: pointer; transition: all 0.2s ease; }
        .settings-btn-sm:hover { background: var(--accent-primary); color: var(--bg-primary); }
        .settings-btn-group { display: flex; gap: 8px; align-items: center; }

        .theme-selector { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .theme-option { padding: 10px; border: 2px solid var(--border-color); border-radius: var(--radius-sm); cursor: pointer; text-align: center; transition: all 0.2s ease; position: relative; }
        .theme-option.active { border-color: var(--accent-primary); box-shadow: var(--shadow-glow); }
        .theme-preview { display: flex; justify-content: center; gap: 5px; margin-top: 8px; }
        /* Changed theme-preview-dot to be smaller as requested */
        .theme-preview-dot { width: 12px; height: 12px; border-radius: 50%; }
        .theme-option .delete-hint { position: absolute; top: 4px; right: 4px; font-size: 10px; color: var(--text-muted); opacity: 0; transition: opacity 0.2s ease; pointer-events: none; }
        .theme-option:hover .delete-hint { opacity: 0.7; }

        /* Lightbox / Modal Viewer Styles */
        .lightbox {
            display: none; position: fixed; z-index: 3000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.95);
            justify-content: center; align-items: center; flex-direction: column;
        }
        .lightbox-content { margin: auto; display: block; max-width: 90%; max-height: 85%; }
        .lightbox-close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer; z-index: 3001; }
        .lightbox-close:hover, .lightbox-close:focus { color: var(--accent-primary); text-decoration: none; }
        @keyframes zoomIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        .lightbox-content, .lightbox-caption { animation: zoomIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Color Picker Styles */
        .color-picker-wrapper { margin-top: 10px; }
        .color-picker-ui { display: flex; gap: 10px; }
        .color-picker-sv-canvas { width: 240px; height: 160px; cursor: crosshair; border: 1px solid var(--border-color); border-radius: var(--radius); }
        .color-picker-hue-canvas { width: 30px; height: 160px; cursor: pointer; border: 1px solid var(--border-color); border-radius: var(--radius); }
        .color-picker-controls { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .color-picker-preview { width: 30px; height: 30px; border-radius: 50%; border: 2px solid var(--border-color); }
        .color-picker-hex-input { background: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 5px 8px; border-radius: var(--radius-sm); width: 90px; font-family: monospace; text-align: center; }
        
        /* REWRITTEN ARTIFACT STYLES (MOBILE-FIRST & SLIMMER) */
        .artifact-placeholder {
            /* This is the container for the artifact INSIDE a message bubble */
            /* We will mostly add this to its own message bubble now. */
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            animation: slideInUp 0.5s ease-out;
            margin: 0; /* Remove margin-top as it will be in its own bubble */
        }
        .message-content > .artifact-placeholder {
             /* When an artifact is the ONLY thing in a message, we remove the extra padding */
            margin: -20px; /* Counteract parent padding */
        }
        @media (max-width: 768px) {
            .message-content > .artifact-placeholder {
                margin: -14px; /* Counteract smaller mobile padding */
            }
        }
        
        .artifact-header {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
            margin-bottom: 8px;
        }
        .artifact-icon {
            font-size: 24px;
            color: var(--accent-primary);
            width: 30px;
            text-align: center;
            flex-shrink: 0;
        }
        .artifact-details {
            flex-grow: 1;
            min-width: 0;
        }
        .artifact-details .title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }
        .artifact-details .description {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .artifact-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            align-self: flex-end; 
        }
        .artifact-btn {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 5px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            border-radius: 999px;
        }
        .artifact-btn.primary {
            background: var(--accent-primary);
            color: var(--bg-primary);
            border-color: var(--accent-primary);
        }
        .artifact-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }
        
        /* Desktop layout for artifacts */
        @media (min-width: 600px) {
            .artifact-placeholder {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
                padding: 8px 15px;
            }
            .artifact-header {
                margin-bottom: 0; /* Remove the margin for the desktop row layout */
            }
            .artifact-actions {
                align-self: center;
            }
        }

        /* UPDATED ARTIFACT VIEWER MODAL */
        #artifact-viewer-modal .modal-box {
            width: 100vw; height: 100vh; max-width: 100vw; max-height: 100vh;
            padding: 0;
            border-radius: 0;
            border: none;
            background-color: var(--bg-primary); /* Ensure background color */
        }
        .artifact-viewer-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; border-bottom: 1px solid var(--border-color);
            flex-shrink: 0; background-color: var(--bg-primary);
            position: relative; /* MODIFICATION: Ensure stacking context */
            z-index: 1; /* MODIFICATION: Keep header above content */
        }
        .artifact-viewer-title-group { display: flex; align-items: center; gap: 15px; min-width: 0; }
        .artifact-viewer-title {
            font-size: 16px; font-weight: 600; color: var(--text-primary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .artifact-viewer-tabs { display: flex; gap: 5px; flex-shrink: 0; }
        .artifact-tab-btn {
            padding: 8px 16px; background: var(--bg-tertiary); border: 1px solid var(--border-color);
            color: var(--text-secondary); border-radius: 999px; font-size: 14px; cursor: pointer;
            transition: all 0.2s ease;
        }
        .artifact-tab-btn.active, .artifact-tab-btn:hover {
            background: var(--accent-primary); color: var(--bg-primary);
        }
        .artifact-viewer-actions { display: flex; align-items: center; gap: 8px; }
        .artifact-action-btn {
            padding: 0; 
            /* FIX: INCREASED TAP TARGET SIZE */
            width: 40px; height: 40px;
            background: var(--bg-tertiary); border: 1px solid var(--border-color);
            color: var(--text-secondary); border-radius: 50%;
            font-size: 16px; cursor: pointer; transition: all 0.2s ease;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .artifact-action-btn:hover {
            background: var(--accent-primary); color: var(--bg-primary); border-color: var(--accent-primary);
        }
        .artifact-action-btn.active {
            background: var(--accent-primary); color: var(--bg-primary);
        }
        #artifact-viewer-modal .modal-close-btn {
            position: static; /* Keep it in the flow of actions */
        }
        .artifact-viewer-content {
            flex-grow: 1; position: relative; overflow: hidden;
        }
        .artifact-pane {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s;
            display: flex; flex-direction: column;
        }
        .artifact-pane.active {
            opacity: 1; visibility: visible;
        }
        #artifact-preview-pane iframe {
            width: 100%; height: 100%; border: none; background: #fff;
        }
        #artifact-code-pane {
            background-color: var(--bg-secondary); /* Match theme */
        }
        #artifact-code-pane pre {
            flex-grow: 1; overflow: auto; margin: 0;
            padding: 20px !important;
            font-size: 14px; line-height: 1.6;
            background: transparent !important;
        }
        #artifact-code-pane pre, #artifact-code-pane code {
            text-shadow: none !important;
        }
        #artifact-code-pane code[contenteditable="true"] {
            outline: none;
            caret-color: var(--accent-primary);
        }

        /* NEW DISCOVER PAGE STYLES */
        #discoverPage {
            display: none; /* Hidden by default */
            flex-direction: column;
            animation: fadeIn 0.5s ease-out;
            flex-grow: 1; /* Allow it to take up space */
        }
        .discover-nav-header {
            padding: 10px 15px;
            background: rgba(10,10,10,0.85);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            flex-shrink: 0;
            position: sticky;
            top: 59px; /* Approx height of main header */
            z-index: 99;
        }
        .discover-nav-header::-webkit-scrollbar { display: none; }
        .discover-nav-header { -ms-overflow-style: none; scrollbar-width: none; }
        .nav-link {
            display: inline-block;
            padding: 8px 16px;
            margin: 0 5px;
            text-decoration: none;
            color: var(--text-muted);
            background-color: transparent;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .nav-link.active, .nav-link:hover {
            background-color: var(--accent-primary);
            color: var(--bg-primary);
        }
        .card-feed {
            padding: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            flex-grow: 1;
        }
        .card {
            background-color: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            opacity: 0; /* For Anime.js animations */
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-glow);
            border-color: var(--accent-primary);
        }
        .card-thumbnail {
            width: 100%;
            height: 180px;
            object-fit: cover;
            transition: transform 0.4s ease;
        }
        .card:hover .card-thumbnail {
            transform: scale(1.05);
        }
        .card-content {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .card-content h2 {
            margin: 0 0 10px 0;
            font-size: 1.2rem;
            line-height: 1.4;
            color: var(--text-primary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .card-content p {
            margin: 0 0 15px 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .card-source {
            margin-top: auto;
            padding-top: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            color: var(--text-muted);
        }
        .center-message-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            grid-column: 1 / -1; /* Span all grid columns */
        }
        .loader {
            border: 5px solid var(--border-color);
            border-top: 5px solid var(--accent-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        .discover-article-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-primary); z-index: 100;
            display: flex; flex-direction: column;
            transform: translateY(100%);
            visibility: hidden;
        }
        .discover-modal-header {
            padding: 10px 15px; display: flex; justify-content: flex-end;
            border-bottom: 1px solid var(--border-color); flex-shrink: 0;
        }
        .discover-modal-close-btn {
            font-size: 2rem; font-weight: bold; color: var(--text-muted);
            cursor: pointer; background: none; border: none; line-height: 1;
        }
        .discover-modal-close-btn:hover { color: var(--text-primary); }
        .discover-modal-content-area { padding: 20px; overflow-y: auto; flex-grow: 1; }
        .discover-modal-content-area img { max-width: 100%; height: auto; border-radius: 8px; margin-bottom: 20px; }
        .discover-modal-content-area h1 { font-size: 1.8rem; margin-bottom: 20px; color: var(--text-primary); }
        .discover-modal-content-area p { line-height: 1.7; font-size: 1.1rem; white-space: pre-wrap; color: var(--text-primary); }
        .discover-modal-content-area .error-text { white-space: pre-wrap; color: var(--error); }
        
        /* NEW: Voice Chat Modal */
        #voice-chat-modal .modal-overlay {
            background-color: rgba(0,0,0,0.9);
        }
        .voice-chat-container {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; gap: 25px; position: relative;
        }
        .voice-chat-container .modal-close-btn {
            position: absolute; top: -30px; right: -30px;
        }
        .voice-visualizer {
            width: 150px; height: 150px; border-radius: 50%;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s ease;
            position: relative;
        }
        .voice-visualizer:hover {
            border-color: var(--accent-primary);
            transform: scale(1.05);
        }
        .voice-visualizer i {
            font-size: 40px; color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        .voice-visualizer:hover i {
            color: var(--text-primary);
        }
        .voice-visualizer.listening {
            border-color: var(--error);
            box-shadow: 0 0 30px rgba(255, 68, 68, 0.5);
            animation: pulse-red 1.5s infinite;
        }
        .voice-visualizer.listening i {
            color: var(--error);
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.5); }
            70% { box-shadow: 0 0 0 20px rgba(255, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); }
        }
        #voice-chat-status {
            font-size: 16px; color: var(--text-secondary);
        }
        #visualizer-canvas-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
        }
    </style>
</head>
<body>
    <video id="video-background" loop muted playsinline></video>
    <canvas id="three-background"></canvas>

    <!-- Landing Page -->
    <div id="landingPage" class="landing-page">
        <div class="landing-container">
            <div class="landing-logo">SKYTH</div>
            <div class="landing-subtitle">The Genesis Engine</div>
            <form id="login-form" class="landing-login-form">
                <input type="text" id="username-input" class="landing-input" placeholder="Enter your name to begin" required>
                <button type="submit" class="landing-btn">Enter SKYTH</button>
            </form>
        </div>
    </div>
    
    <!-- Main Application -->
    <div id="mainApp" class="main-app">
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <a id="logo" class="logo" title="Go to Home">
                        <div class="logo-switch-icon">
                            <div class="logo-switch-left"></div>
                            <div class="logo-switch-right"></div>
                        </div>
                        <div class="logo-text">SKYTH ENGINE</div>
                    </a>
                    <div class="user-info">
                        <button id="discover-btn" class="header-btn" title="Discover"><i class="fas fa-compass"></i></button>
                        <button id="profile-btn" class="header-btn" title="Profile & Settings"><i class="fas fa-user-circle"></i></button>
                        <button id="controls-toggle-btn" class="header-btn" title="Toggle Controls"><i class="fas fa-chevron-down"></i></button>
                        <a href="#" id="logout-btn" class="header-btn">Logout</a>
                    </div>
                </div>
                <div class="header-controls-wrapper" id="header-controls-wrapper">
                    <div class="controls-container">
                        <div class="persona-controls">
                            <button class="persona-btn" data-persona="default">Default</button>
                            <button class="persona-btn" data-persona="academic">Academic</button>
                            <button class="persona-btn" data-persona="unhinged">Unhinged</button>
                            <button class="persona-btn" data-persona="coding">Coding</button>
                            <button class="persona-btn" data-persona="custom">Custom</button>
                        </div>
                        <div class="god-mode-toggle" id="god-mode-toggle">
                            <span id="god-mode-label">God Mode OFF</span>
                            <div class="toggle-switch" id="god-mode-switch"></div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div id="main-content-wrapper">
            <main class="main">
                <div class="container">
                    <div class="search-section" id="initial-search-section">
                        <h1 id="greeting" class="search-title">The Genesis Engine</h1>
                        <p class="search-subtitle">Advanced AI: Real-time research, dynamic visuals, deep insights, and voice synthesis.</p>
                        <div class="search-container">
                            <input type="text" class="search-input" id="initial-search-input"
                                   placeholder="Ask anything..."/>
                            <button class="search-button" id="initial-search-button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>

                        <div id="popular-topics-section" style="max-width: 700px; margin: 30px auto 0 auto;">
                            <details open>
                                <summary>Popular Topics</summary>
                                <div class="details-content" style="padding-top: 15px;">
                                    <div id="popular-topics-grid" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                                        <div style="color: var(--text-muted);">Loading popular topics...</div>
                                    </div>
                                </div>
                            </details>
                        </div>
                    </div>

                    <div class="conversation" id="conversation"></div>
                </div>
            </main>

            <div class="sticky-input-bar" id="sticky-input-bar">
                <div class="container">
                    <div class="search-container multimodal-input-container">
                        <div id="image-preview-container">
                            <img id="image-preview-thumbnail" src="" alt="Image preview">
                            <button id="remove-image-btn" title="Remove image">&times;</button>
                        </div>
                        <div id="file-preview-container">
                            <i id="file-preview-icon" class="fas fa-file-alt"></i>
                            <span id="file-preview-name"></span>
                            <button id="remove-file-btn" title="Remove file">&times;</button>
                        </div>
                        <div class="multimodal-toggle" id="multimodal-toggle">
                            <i class="fas fa-plus"></i>
                            <div class="multimodal-menu" id="multimodal-menu">
                                <div class="multimodal-option" id="voice-option">
                                    <i class="fas fa-microphone"></i>
                                    <span>Voice Message</span>
                                </div>
                                <div class="multimodal-option" id="image-upload-option">
                                    <i class="fas fa-image"></i>
                                    <span>Upload Image</span>
                                </div>
                                <div class="multimodal-option" id="file-upload-option">
                                    <i class="fas fa-file"></i>
                                    <span>Upload File</span>
                                </div>
                                <div class="multimodal-option" id="camera-option">
                                    <i class="fas fa-camera"></i>
                                    <span>Take Photo</span>
                                </div>
                            </div>
                        </div>
                        <textarea id="chat-input" placeholder="Ask a follow-up or new question..." rows="1"></textarea>
                        <button class="search-button" id="chat-button" title="Send"><i class="fas fa-arrow-up"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW Discover Page -->
        <div id="discoverPage">
            <header class="discover-nav-header">
                <nav id="discover-category-nav"></nav>
            </header>
            <main id="discover-card-feed" class="card-feed"></main>
            <div id="discover-article-modal" class="discover-article-modal">
                <div class="discover-modal-header">
                    <button id="discover-modal-close-btn" class="discover-modal-close-btn">&times;</button>
                </div>
                <div class="discover-modal-content-area"></div>
            </div>
        </div>
    </div>
    
    <div class="status-bar" id="status-bar"></div>
    <button id="scroll-to-bottom-btn" style="position: fixed; bottom: 95px; right: 20px; background: var(--accent-primary); color: var(--bg-primary); border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 20px; cursor: pointer; box-shadow: var(--shadow); display: none; z-index: 999;" title="Scroll to Bottom"><i class="fas fa-arrow-down"></i></button>

    <!-- Hidden file inputs -->
    <input type="file" id="hidden-image-input" accept="image/*" style="display: none;">
    <input type="file" id="hidden-file-input" style="display: none;">

    <!-- Modals -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close-btn">×</button>
            <h3 class="modal-header">Profile & Personalization</h3>
            <div class="modal-content">
                <div class="settings-section pfp-upload-container">
                    <img id="pfp-preview" src="" alt="Profile picture preview">
                    <div>
                        <label for="profile-pic-upload" class="settings-label">Profile Picture</label>
                        <input type="file" id="profile-pic-upload" accept="image/*" style="display: none;">
                        <button class="settings-btn-sm" onclick="gebi('profile-pic-upload').click()">Upload Image</button>
                         <small style="color: var(--text-muted); font-size: 12px; margin-top: 5px; display: block;">Tap the image 7 times for a surprise!</small>
                    </div>
                </div>
                <div class="settings-section">
                    <label for="username-change-input" class="settings-label">Username</label>
                    <input type="text" id="username-change-input" class="settings-input">
                </div>
                 <div class="settings-section">
                    <label for="permanent-custom-persona-input" class="settings-label">Permanent Custom Persona</label>
                    <textarea id="permanent-custom-persona-input" class="settings-textarea" placeholder="Define a permanent custom persona for the AI, e.g., 'You are a sarcastic pirate who loves technology.' This will be used when you select the 'Custom' persona."></textarea>
                </div>
                <div class="settings-section">
                    <label class="settings-label">Theme</label>
                    <div id="theme-selector-container" class="theme-selector">
                        <!-- Theme options will be dynamically inserted here -->
                    </div>
                </div>
                <div class="settings-section">
                    <label class="settings-label">Video Background (.mp4)</label>
                    <input type="file" id="video-bg-upload" accept="video/mp4" style="display: none;">
                    <div class="settings-btn-group">
                        <button class="settings-btn-sm" onclick="gebi('video-bg-upload').click()">Upload Video</button>
                        <button class="settings-btn-sm" id="clear-video-bg-btn">Clear Video</button>
                    </div>
                    <small style="color: var(--text-muted); font-size: 12px; margin-top: 5px; display: block;">Video is not saved and will be cleared on page refresh. For a persistent background, use a static image.</small>
                </div>
                <div class="settings-section">
                    <label class="settings-label">Static Image Background</label>
                    <input type="file" id="image-bg-upload" accept="image/*" style="display: none;">
                    <div class="settings-btn-group">
                        <button class="settings-btn-sm" onclick="gebi('image-bg-upload').click()">Upload Image</button>
                        <button class="settings-btn-sm" id="clear-image-bg-btn">Clear Image</button>
                    </div>
                    <small style="color: var(--text-muted); font-size: 12px; margin-top: 5px; display: block;">Overrides video and particle backgrounds.</small>
                </div>
                <!-- Removed ElevenLabs API Key input as requested -->
            </div>
        </div>
    </div>
    
    <div id="media-lightbox" class="lightbox">
        <span class="lightbox-close">×</span>
        <img class="lightbox-content" id="lightbox-img" style="display: none;">
        <video class="lightbox-content" id="lightbox-video" controls style="display: none;"></video>
        <div class="lightbox-content" id="lightbox-iframe-container" style="display: none; width: 80%; max-width: 1280px; aspect-ratio: 16/9;">
            <iframe id="lightbox-iframe" width="100%" height="100%" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
    </div>

    <div id="theme-engine-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 380px;">
            <button class="modal-close-btn">×</button>
            <h3 class="modal-header">Create Custom Theme</h3>
            <div class="modal-content">
                <div class="settings-section">
                    <label for="custom-theme-name" class="settings-label">Theme Name</label>
                    <input type="text" id="custom-theme-name" class="settings-input" placeholder="My Awesome Theme" required>
                </div>
                <div class="settings-section">
                    <label class="settings-label">Primary Accent</label>
                    <div class="color-picker-wrapper" id="accent1-picker"></div>
                </div>
                <div class="settings-section">
                    <label class="settings-label">Secondary Accent</label>
                    <div class="color-picker-wrapper" id="accent2-picker"></div>
                </div>
                <div class="settings-section">
                    <label class="settings-label">Primary Background</label>
                    <div class="color-picker-wrapper" id="bg1-picker"></div>
                </div>
                <button id="save-custom-theme-btn" class="settings-btn-sm" style="width: 100%; padding: 12px; margin-top: 10px;">Save and Apply</button>
            </div>
        </div>
    </div>

    <!-- NEW: Voice Chat Modal -->
    <div id="voice-chat-modal" class="modal-overlay">
        <div id="visualizer-canvas-container"></div>
        <div class="voice-chat-container">
            <div class="voice-visualizer" id="voice-visualizer">
                <i class="fas fa-microphone"></i>
            </div>
            <p id="voice-chat-status">Tap to Speak</p>
            <button class="modal-close-btn">×</button>
        </div>
    </div>

    <!-- UPDATED: Artifact Viewer Modal -->
    <div id="artifact-viewer-modal" class="modal-overlay" style="z-index: 4000;">
        <div class="modal-box">
            <div class="artifact-viewer-header">
                <div class="artifact-viewer-title-group">
                    <h3 class="artifact-viewer-title">Artifact Viewer</h3>
                    <div class="artifact-viewer-tabs">
                        <button class="artifact-tab-btn active" data-tab="preview">Preview</button>
                        <button class="artifact-tab-btn" data-tab="code">Code</button>
                    </div>
                </div>
                <div class="artifact-viewer-actions">
                    <button id="artifact-copy-btn" class="artifact-action-btn" title="Copy Code"><i class="fas fa-copy"></i></button>
                    <button id="artifact-edit-btn" class="artifact-action-btn" title="Edit Code"><i class="fas fa-pencil-alt"></i></button>
                    <button id="artifact-save-btn" class="artifact-action-btn" title="Save File"><i class="fas fa-save"></i></button>
                    <button id="artifact-fullscreen-btn" class="artifact-action-btn" title="Toggle Fullscreen"><i class="fas fa-expand"></i></button>
                    <button id="artifact-viewer-close-btn" class="modal-close-btn artifact-action-btn" title="Close Viewer">&times;</button>
                </div>
            </div>
            <div class="artifact-viewer-content">
                <div id="artifact-preview-pane" class="artifact-pane active">
                    <iframe id="artifact-iframe" sandbox="allow-scripts allow-popups allow-forms"></iframe>
                </div>
                <div id="artifact-code-pane" class="artifact-pane">
                    <pre><code id="artifact-code-content" class="language-html"></code></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global Variables ---
        let isGodMode = false, currentPersona = 'default', permanentCustomPersonaPrompt = '', isSearching = false, chatHistory = [];
        let userOpenRouterApiKey = ''; 
        let currentUser = null, userProfilePic = null;
        let messageIdCounter = 0;
        let customThemes = {};
        let colorPickers = {};
        let currentPlayingAudio = null;
        let attachedImageData = null;
        let attachedFileData = null;
        let attachedFileName = null;

        // --- Discover Page Variables ---
        let currentDiscoverCategory = 'For You';
        let isDiscoverInitialized = false;

        // --- Voice/Visualizer Variables ---
        let voiceVisualizerInstance = null;
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let microphoneStream = null;

        // --- Element Getters ---
        const gebi = (id) => document.getElementById(id); 
        const landingPage = gebi('landingPage'), mainApp = gebi('mainApp');
        const mainContentWrapper = gebi('main-content-wrapper'), discoverPage = gebi('discoverPage');
        const initialSearchSection = gebi('initial-search-section'), initialSearchInput = gebi('initial-search-input'), initialSearchButton = gebi('initial-search-button');
        const chatInput = gebi('chat-input'), chatButton = gebi('chat-button'), conversation = gebi('conversation');
        const godModeSwitch = gebi('god-mode-switch'), godModeLabel = gebi('god-mode-label'), statusBar = gebi('status-bar'), stickyInputBar = gebi('sticky-input-bar');
        const personaButtons = document.querySelectorAll('.persona-btn');
        const scrollToBottomBtn = gebi('scroll-to-bottom-btn');
        const greetingEl = gebi('greeting');
        const videoBackground = gebi('video-background');
        const multimodalToggle = gebi('multimodal-toggle');
        const multimodalMenu = gebi('multimodal-menu');
        const voiceOption = gebi('voice-option');
        const imageUploadOption = gebi('image-upload-option');
        const fileUploadOption = gebi('file-upload-option');
        const hiddenImageInput = gebi('hidden-image-input');
        const hiddenFileInput = gebi('hidden-file-input');
        const imagePreviewContainer = gebi('image-preview-container');
        const imagePreviewThumbnail = gebi('image-preview-thumbnail');
        const removeImageBtn = gebi('remove-image-btn');
        const filePreviewContainer = gebi('file-preview-container');
        const filePreviewName = gebi('file-preview-name');
        const removeFileBtn = gebi('remove-file-btn');
        const voiceChatModal = gebi('voice-chat-modal');
        const voiceVisualizer = gebi('voice-visualizer');
        const voiceChatStatus = gebi('voice-chat-status');

        // --- Authentication & UI State ---
        function checkAuthentication() {
            currentUser = localStorage.getItem('skyth_username');
            if (currentUser) {
                loadSettings();
                showMainApp();
                updateGreeting();
            } else {
                showLandingPage();
            }
        }

        function showLandingPage() {
            landingPage.style.display = 'flex';
            mainApp.style.display = 'none';
            anime.timeline({ easing: 'easeOutExpo', duration: 1000 })
                .add({ targets: '.landing-logo', opacity: [0, 1], translateY: [30, 0], delay: 200 })
                .add({ targets: '.landing-subtitle', opacity: [0, 1], translateY: [20, 0], offset: '-=600' })
                .add({ targets: '.landing-login-form', opacity: [0, 1], translateY: [20, 0], offset: '-=600' });
        }

        function showMainApp() {
            landingPage.style.display = 'none';
            mainApp.style.display = 'flex';
            showMainSearch();
            initialSearchInput.focus();
        }

        function handleLogin(event) {
            event.preventDefault();
            const username = gebi('username-input').value.trim();
            if (username) {
                localStorage.setItem('skyth_username', username);
                currentUser = username;
                checkAuthentication();
            }
        }

        function handleLogout() {
            localStorage.removeItem('skyth_username');
            currentUser = null;
            chatHistory = [];
            conversation.innerHTML = '';
            showMainSearch();
            initialSearchSection.style.display = 'block';
            stickyInputBar.style.display = 'none';
            checkAuthentication();
        }

        const greetings = [
            "How's it going, {user}!",
            "Back at it, {user}!",
            "What's up, {user}!",
            "Ready for more, {user}?",
            "Hey there, {user}! What's on your mind?",
            "Good to see you, {user}!",
            "How can I assist you today, {user}?",
            "Let's explore, {user}!",
            "Hey, {user}! What's the latest?",
            "Hope you're having a great day, {user}!"
        ];

        function updateGreeting() {
            const hour = new Date().getHours();
            let greetingText;

            // Specific time-based greetings
            if (hour >= 5 && hour < 12) {
                greetingText = `Good morning, {user}!`;
            } else if (hour >= 12 && hour < 17) {
                greetingText = `Good afternoon, {user}!`;
            } else if (hour >= 17 && hour < 22) {
                greetingText = `Good evening, {user}!`;
            } else {
                greetingText = `What's up, night owl {user}!`;
            }
            
            // Random general greeting if not a specific time
            if (Math.random() < 0.5 || !currentUser) { // 50% chance or if no user specific time
                greetingText = greetings[Math.floor(Math.random() * greetings.length)];
            }
            
            greetingEl.textContent = greetingText.replace('{user}', currentUser || 'User');
        }
        
        // --- Search & Stream Handling ---
        function handleInitialKeyPress(event) { if (event.key === 'Enter' && !isSearching) handleInitialSearch(); }
        function handleChatKeyPress(event) { if (event.key === 'Enter' && !event.shiftKey && !isSearching) { event.preventDefault(); performChatSearch(); } }
        function handleInitialSearch() { const q = initialSearchInput.value.trim(); if (!q && !attachedImageData && !attachedFileData) return; initialSearchSection.style.display = 'none'; stickyInputBar.style.display = 'flex'; chatInput.focus(); performSearch(q); }
        function performChatSearch() { const q = chatInput.value.trim(); if (!q && !attachedImageData && !attachedFileData) return; performSearch(q); }
        
        async function performSearch(query) {
            if (isSearching) return;
            isSearching = true;
            setSearchButtonState(true);
            
            showMainSearch(); // Ensure we are on the main chat view

            let userQuery;
            if (query) {
                userQuery = query;
            } else if (attachedImageData) {
                userQuery = 'Describe this image.'; // Changed default query
            } else if (attachedFileData) {
                userQuery = `Summarize this file: ${attachedFileName}`;
            } else {
                isSearching = false;
                setSearchButtonState(false);
                return;
            }

            addMessageToConversation(userQuery, 'user', false, attachedImageData, attachedFileData, attachedFileName);
            chatHistory.push({ role: 'user', content: userQuery });
            initialSearchInput.value = '';
            chatInput.value = '';
            chatInput.style.height = 'auto'; // Reset height

            const imageDataToSend = attachedImageData;
            const fileDataToSend = attachedFileData;
            const fileNameToSend = attachedFileName;
            
            // For continuous editing, we DON'T clear the image data yet.
            // It will be replaced by the *new* edited image upon response.
            // But we do clear the file data as it's a one-off analysis.
            if (fileDataToSend) {
                removeFilePreview();
            }


            try {
                const payload = { 
                    query: userQuery, 
                    persona: currentPersona, 
                    custom_persona_prompt: currentPersona === 'custom' ? permanentCustomPersonaPrompt : '', 
                    is_god_mode: isGodMode, 
                    history: chatHistory.slice(-30, -1),
                    image_data: imageDataToSend,
                    file_data: fileDataToSend,
                    file_name: fileNameToSend
                };

                if (isGodMode && userOpenRouterApiKey) { payload.openrouter_api_key = userOpenRouterApiKey; }
                
                const response = await fetch('/search', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const errData = await response.json().catch(() => ({error: `HTTP ${response.status}`})); throw new Error(errData.error || `HTTP ${response.status}`);}
                await handleStreamResponse(response, userQuery);
            } catch (error) {
                console.error('Search error:', error);
                const msg = `Error: ${error.message}`;
                addMessageToConversation(msg, 'ai');
                chatHistory.push({ role: 'assistant', content: msg });
                showStatus('Search failed.', 'error');
            } finally {
                isSearching = false;
                setSearchButtonState(false);
                chatInput.focus();
            }
        }
        
        async function handleStreamResponse(response, originalQuery) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            const aiMsgEl = addMessageToConversation('', 'ai', true);
            aiMsgEl.dataset.originalQuery = originalQuery; // Store the original query
            aiMsgEl.scrollIntoView({ behavior: "smooth", block: "start" });
            
            const msgContentEl = aiMsgEl.querySelector('.message-content');
            const thinkingDisplay = document.createElement('div');
            thinkingDisplay.className = 'thinking-display active';
            thinkingDisplay.innerHTML = `<div class="thinking-header"><i class="fas fa-brain"></i><span>Thinking...</span></div><div class="thinking-steps"></div>`;
            msgContentEl.prepend(thinkingDisplay);
            const thinkingStepsContainer = thinkingDisplay.querySelector('.thinking-steps');

            const aiTextEl = document.createElement('div');
            aiTextEl.className = 'message-text';
            msgContentEl.appendChild(aiTextEl);
            
            let currentAIMsgContent = '';
            let isFirstChunk = true;

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                let boundary;
                while ((boundary = buffer.indexOf('\n')) >= 0) {
                    const line = buffer.substring(0, boundary).trim();
                    buffer = buffer.substring(boundary + 1);
                    if (line.startsWith('data: ')) {
                        try {
                            const jsonData = line.substring(5);
                            if (jsonData.trim().toUpperCase() === "[DONE]") continue;
                            const data = JSON.parse(jsonData);
                            switch (data.type) {
                                case 'step': addThinkingStep(data.data.text, data.data.status, thinkingStepsContainer); break;
                                case 'sources': displaySourcesInMessage(aiMsgEl, data.data); break;
                                case 'answer_chunk': 
                                    if(isFirstChunk) { thinkingDisplay.style.display = 'none'; isFirstChunk = false; }
                                    currentAIMsgContent += data.data;
                                    let processedContent = currentAIMsgContent.replace(/\[x\]/g, '\\lfloor x \\rfloor');
                                    aiTextEl.innerHTML = marked.parse(processedContent + '▌'); 
                                    break;
                                case 'canvas_visualization': 
                                    createHtmlArtifact(aiMsgEl, data.data.html_code, 'Interactive Visualization');
                                    break;
                                case 'html_preview':
                                    // NEW: Handle stock charts differently
                                    if (data.data.html_code.includes('id="stockChart"')) {
                                        aiMsgEl.classList.add('is-stock-message'); // Flag this message
                                        
                                        const chartContainer = document.createElement('div');
                                        chartContainer.style.cssText = `
                                            width: 100%;
                                            aspect-ratio: 16 / 9;
                                            margin-bottom: 20px;
                                            border-radius: var(--radius-sm);
                                            overflow: hidden;
                                            border: 1px solid var(--border-color);
                                        `;
                                        const chartIframe = document.createElement('iframe');
                                        chartIframe.style.cssText = 'width: 100%; height: 100%; border: none;';
                                        chartIframe.srcdoc = data.data.html_code;
                                        chartContainer.appendChild(chartIframe);
                                        aiTextEl.before(chartContainer); // Place chart before the text element
                                    } else {
                                        createHtmlArtifact(aiMsgEl, data.data.html_code, 'HTML Preview');
                                    }
                                    break;
                                case 'generated_image': 
                                case 'uploaded_image': 
                                    createImageArtifact(aiMsgEl, `data:image/jpeg;base64,${data.data.base64_data}`, data.data.title || 'Generated Image');
                                    break;
                                case 'edited_image':
                                    // This is the new image that will be the context for the *next* edit.
                                    attachedImageData = data.data.base64_data;
                                    displayImagePreview(`data:image/jpeg;base64,${attachedImageData}`);
                                    
                                    // Mark this message bubble as containing an edit result to prevent restructuring
                                    aiMsgEl.classList.add('contains-edited-image');
                                    
                                    // Display the new image within the current AI message bubble
                                    createImageArtifact(aiMsgEl, `data:image/jpeg;base64,${data.data.base64_data}`, data.data.title || 'Edited Image');
                                    break;
                                case 'image_search_results': 
                                case 'video_search_results':
                                    const isImage = data.type === 'image_search_results';
                                    const mediaTypeForGrid = isImage ? 'image' : 'video';
                                    const title = isImage ? 'Image Search Results' : 'Video Search Results';
                                    displayMediaResults(aiMsgEl, data.data, title, mediaTypeForGrid);
                                    break;
                                case 'follow_up_suggestions': displaySuggestions(aiMsgEl, data.data); break;
                                case 'error': const errMsg = `Error: ${data.data.message || data.data}`; currentAIMsgContent += `\n\n${errMsg}`; aiTextEl.innerHTML = marked.parse(currentAIMsgContent); showStatus('Error in response.', 'error'); break;
                            }
                        } catch (e) { console.warn('Stream parse error:', line, e); }
                    }
                }
            }

            if (thinkingDisplay.style.display !== 'none') thinkingDisplay.style.display = 'none';
            
            let finalProcessedContent = currentAIMsgContent.replace(/\[x\]/g, '\\lfloor x \\rfloor');
            aiTextEl.innerHTML = marked.parse(finalProcessedContent);
            
            aiMsgEl.dataset.rawContent = currentAIMsgContent;
            
            processCodeBlocks(aiTextEl);
            if (window.MathJax) { MathJax.typesetPromise([aiTextEl]).catch(console.error); }
            
            addMediaActionButtons(aiMsgEl, currentAIMsgContent);

            chatHistory.push({ role: 'assistant', content: currentAIMsgContent });
            
            restructureMessageContent(aiMsgEl);
            
            showStatus('Search complete', 'success');
        }
        
        // --- Voice & Audio Functions ---
        async function readTextAloud(text, buttonElement) {
            if (currentPlayingAudio && !currentPlayingAudio.paused) {
                currentPlayingAudio.pause();
                return;
            }

            const originalIconHTML = '<i class="fas fa-volume-up"></i> Read aloud';
            const originalOnClick = buttonElement.onclick;

            buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Synthesizing...';
            buttonElement.disabled = true;

            // Check if ElevenLabs API Key is available
            const elevenLabsApiKey = localStorage.getItem('elevenlabs_api_key');
            if (!elevenLabsApiKey) {
                showStatus('ElevenLabs API Key not found. Please add it in settings for voice synthesis.', 'error');
                buttonElement.innerHTML = originalIconHTML;
                buttonElement.disabled = false;
                return;
            }

            try {
                const response = await fetch('/api/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text, persona: currentPersona, api_key: elevenLabsApiKey })
                });

                if (!response.ok) {
                    const err = await response.json().catch(() => ({ error: 'TTS request failed' }));
                    throw new Error(err.error || `HTTP ${response.status}`);
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                currentPlayingAudio = audio;
                
                audio.play();
                buttonElement.innerHTML = '<i class="fas fa-stop-circle"></i> Stop';
                buttonElement.disabled = false;
                
                buttonElement.onclick = () => { audio.pause(); };

                audio.onpause = audio.onended = () => {
                    buttonElement.innerHTML = originalIconHTML;
                    buttonElement.onclick = originalOnClick;
                    if (currentPlayingAudio === audio) {
                        currentPlayingAudio = null;
                    }
                    URL.revokeObjectURL(audioUrl);
                };

            } catch (error) {
                console.error("TTS Error:", error);
                showStatus(error.message, 'error');
                buttonElement.innerHTML = originalIconHTML;
                buttonElement.disabled = false;
                buttonElement.onclick = originalOnClick;
            }
        }
        
        async function startVoiceRecording() {
            if (isRecording) return;
            try {
                // Check if ElevenLabs API Key is available for transcription (if applicable, though backend handles this)
                const elevenLabsApiKey = localStorage.getItem('elevenlabs_api_key');
                if (!elevenLabsApiKey) {
                    showStatus('ElevenLabs API Key not found. Required for voice transcription.', 'error');
                    return;
                }

                microphoneStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                voiceVisualizerInstance.connectMicrophone(microphoneStream);
                mediaRecorder = new MediaRecorder(microphoneStream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
                
                mediaRecorder.onstop = async () => {
                    voiceChatStatus.textContent = 'Transcribing...';
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    
                    const formData = new FormData();
                    formData.append('file', audioBlob, 'voice-message.webm');
                    formData.append('api_key', elevenLabsApiKey); // Pass key to backend

                    try {
                        const response = await fetch('/api/transcribe_audio', {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();

                        if (!response.ok || result.error) {
                            throw new Error(result.error || 'Transcription failed.');
                        }

                        if (result.text) {
                            chatInput.value = result.text;
                            showStatus('Transcription successful!', 'success');
                            performChatSearch();
                        } else {
                            throw new Error('API did not return text.');
                        }

                    } catch (error) {
                        console.error('Transcription error:', error);
                        showStatus(`Transcription failed: ${error.message}`, 'error');
                    } finally {
                        closeVoiceChat();
                    }
                };
                
                mediaRecorder.start();
                isRecording = true;
                voiceVisualizer.classList.add('listening');
                voiceChatStatus.textContent = 'Listening... Tap to stop';
            } catch (error) {
                console.error('Error starting voice recording:', error);
                showStatus('Could not access microphone', 'error');
                closeVoiceChat();
            }
        }

        function stopVoiceRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                microphoneStream.getTracks().forEach(track => track.stop());
                isRecording = false;
                voiceVisualizer.classList.remove('listening');
                voiceVisualizerInstance.disconnectMicrophone();
            }
        }

        function openVoiceChat() {
            voiceChatModal.style.display = 'flex';
            document.body.classList.add('modal-open'); // Prevent background scroll
            if (!voiceVisualizerInstance) {
                voiceVisualizerInstance = new CyberpunkVisualizer(gebi('visualizer-canvas-container'));
            }
            voiceChatStatus.textContent = 'Tap to Speak';
        }

        function closeVoiceChat() {
            if (isRecording) stopVoiceRecording();
            voiceChatModal.style.display = 'none';
            document.body.classList.remove('modal-open'); // Allow background scroll
        }

        // --- UI Rendering & Helpers ---
        function setSearchButtonState(isBusy) { 
            const iconClass = isBusy ? 'fas fa-spinner fa-spin' : 'fas fa-arrow-up';
            chatButton.disabled = isBusy; 
            chatButton.innerHTML = `<i class="${iconClass}"></i>`;
            if (initialSearchButton) {
                initialSearchButton.disabled = isBusy;
                initialSearchButton.innerHTML = isBusy ? '<i class="fas fa-spinner fa-spin"></i>' : '<i class="fas fa-search"></i>';
            }
        }

        function addThinkingStep(step, status, container) {
            const stepElement = document.createElement('div');
            stepElement.className = 'thinking-step active';
            const iconClass = status === 'done' || status === 'complete' ? 'fa-check-circle' : 'fa-cog thinking-icon';
            stepElement.innerHTML = `<i class="fas ${iconClass}"></i><span>${escapeHtml(step)}</span>`;
            container.appendChild(stepElement);
            const allSteps = container.querySelectorAll('.thinking-step');
            if (allSteps.length > 1) {
                const prevStep = allSteps[allSteps.length - 2];
                prevStep.classList.add('completed');
                prevStep.classList.remove('active');
                prevStep.querySelector('.thinking-icon')?.classList.remove('thinking-icon');
            }
        }

        function addMessageToConversation(text, sender, isStreaming = false, imageData = null, fileData = null, fileName = null) { 
            const msgDiv = document.createElement('div'); 
            msgDiv.className = 'message'; 
            msgDiv.id = `msg-${messageIdCounter++}`;
            
            let avatarContent = '';
            let avatarCls;
            let avatarStyle = '';
            if (sender === 'user') {
                avatarCls = 'user-avatar';
                if (userProfilePic && userProfilePic.startsWith('data:image')) {
                    avatarStyle = `style="background-image: url('${userProfilePic}');"`;
                    avatarContent = '';
                } else {
                    avatarContent = currentUser ? currentUser.charAt(0).toUpperCase() : 'U';
                }
            } else {
                avatarCls = 'ai-avatar';
                avatarContent = `<div class="logo-switch-icon" style="width: 18px; height: 18px; transform: rotate(-15deg); border-radius: 4px;"><div class="logo-switch-left"></div><div class="logo-switch-right"></div></div>`;
            }
            const senderName = sender === 'user' ? (currentUser || 'User') : 'SKYTH Engine'; 
            
            let attachmentHtml = '';
            if (imageData) {
                attachmentHtml = `<img src="data:image/jpeg;base64,${imageData}" style="max-width: 200px; border-radius: 10px; margin-bottom: 10px; display: block;">`;
            } else if (fileData) {
                attachmentHtml = `<div class="artifact-placeholder" style="margin-bottom: 10px;"><div class="artifact-header"><i class="artifact-icon fas fa-file-alt"></i><div class="artifact-details"><div class="title">Attached File</div><div class="description">${escapeHtml(fileName)}</div></div></div></div>`;
            }
            
            let messageContentHtml = (sender === 'user' || !isStreaming) ? `<div class="message-text">${attachmentHtml}${marked.parse(escapeHtml(text))}</div>` : attachmentHtml; 
            messageContentHtml += `<div class="message-actions-bottom"><button class="copy-message-btn" title="Copy Message"><i class="fas fa-copy"></i></button></div>`;
            
            msgDiv.innerHTML = `<div class="message-header"><div class="message-avatar ${avatarCls}" ${avatarStyle}>${avatarContent}</div><span>${senderName}</span></div><div class="message-content">${messageContentHtml}</div>`; 
            conversation.appendChild(msgDiv); 
            
            msgDiv.querySelector('.copy-message-btn').addEventListener('click', (e) => { 
                const messageElement = e.currentTarget.closest('.message');
                const textToCopy = messageElement.dataset.rawContent || messageElement.querySelector('.message-text').innerText; 
                navigator.clipboard.writeText(textToCopy).then(() => showStatus('Message copied!', 'success')).catch(() => showStatus('Copy failed.', 'error')); 
            });
            
            msgDiv.dataset.rawContent = text; // Always store raw content
            
            return msgDiv; 
        }
        
        function createCollapsibleSection(messageElement, summaryText, sectionClass) { let section = messageElement.querySelector(`.${sectionClass}`); if (!section) { const details = document.createElement('details'); details.className = sectionClass; const summary = document.createElement('summary'); summary.textContent = summaryText; const contentDiv = document.createElement('div'); contentDiv.className = 'details-content'; details.appendChild(summary); details.appendChild(contentDiv); messageElement.querySelector('.message-content').appendChild(details); section = details; } return section; }
        
        function displaySourcesInMessage(messageElement, sources) {
            if (!sources || sources.length === 0) return;
            const sourcesContainer = createCollapsibleSection(messageElement, "Sources", "sources-details");
            const contentDiv = sourcesContainer.querySelector('.details-content');
            contentDiv.innerHTML = ''; // Clear previous
            const linksHtml = sources.map((source, index) => {
                if (source.type === 'file_upload') {
                    return `<div class="artifact-placeholder" style="margin: 5px 0;"><div class="artifact-header"><i class="artifact-icon fas fa-file-alt"></i><div class="artifact-details"><div class="title">${escapeHtml(source.title)}</div><div class="description">${escapeHtml(source.text)}</div></div></div></div>`;
                }
                if (!source.url || !source.title) return '';
                const domain = new URL(source.url).hostname.replace('www.', '');
                return `<a href="${source.url}" target="_blank" class="topic-chip" title="${escapeHtml(source.title)}">${escapeHtml(domain)}</a>`;
            }).join('');
            contentDiv.innerHTML = `<div class="source-links" style="justify-content: flex-start; gap: 8px;">${linksHtml}</div>`;
        }
                
        function displaySuggestions(messageElement, suggestions) {
            if (!messageElement || !suggestions || suggestions.length === 0) return;
            const suggestionsContainer = document.createElement('div');
            suggestionsContainer.className = 'suggestions';
            const itemsHtml = suggestions.map(s => `<div class="suggestion-item" data-suggestion="${escapeHtml(s)}">${escapeHtml(s)}</div>`).join('');
            suggestionsContainer.innerHTML = `<div class="suggestions-title">Follow-up suggestions:</div><div class="suggestion-items">${itemsHtml}</div>`;
            messageElement.querySelector('.message-content').appendChild(suggestionsContainer);

            suggestionsContainer.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('click', () => {
                    applySuggestion(item.dataset.suggestion);
                });
            });
        }
        
        function applySuggestion(suggestion) { chatInput.value = suggestion; performChatSearch(); }

        function addMediaActionButtons(messageElement, rawContent) {
            const isSimpleGreeting = messageElement.dataset.originalQuery && /^\s*(hi|hello|hey|thanks|thank you|ok|bye)\s*$/i.test(messageElement.dataset.originalQuery.trim());
            const hasMedia = messageElement.querySelector('.image-results-grid, .video-results-grid');
            if (isSimpleGreeting || hasMedia) return;

            let actionsContainer = messageElement.querySelector('.media-actions');
            if (!actionsContainer) {
                actionsContainer = document.createElement('div');
                actionsContainer.className = 'media-actions';
                const suggestionsEl = messageElement.querySelector('.suggestions');
                if (suggestionsEl) {
                    suggestionsEl.insertAdjacentElement('afterend', actionsContainer);
                } else {
                    messageElement.querySelector('.message-content').appendChild(actionsContainer);
                }
            }
            actionsContainer.innerHTML = ''; // Clear it

            // Read Aloud Button
            if (rawContent && rawContent.length > 20) {
                const voiceBtn = document.createElement('button');
                voiceBtn.className = 'media-action-btn';
                voiceBtn.innerHTML = '<i class="fas fa-volume-up"></i> Read aloud';
                voiceBtn.onclick = () => readTextAloud(rawContent, voiceBtn);
                actionsContainer.appendChild(voiceBtn);
            }

            // Search Images Button
            const imageBtn = document.createElement('button');
            imageBtn.className = 'media-action-btn';
            imageBtn.innerHTML = '<i class="fas fa-images"></i> Search for images';
            imageBtn.onclick = () => performSearch('images of ' + messageElement.dataset.originalQuery);
            actionsContainer.appendChild(imageBtn);

            // Search Videos Button
            const videoBtn = document.createElement('button');
            videoBtn.className = 'media-action-btn';
            videoBtn.innerHTML = '<i class="fas fa-video"></i> Search for videos';
            videoBtn.onclick = () => performSearch('video of ' + messageElement.dataset.originalQuery);
            actionsContainer.appendChild(videoBtn);
        }

        // --- ARTIFACT & CODE BLOCK LOGIC ---
        function processCodeBlocks(containerElement) {
            const shellLangs = ['sh', 'bash', 'shell', 'zsh', 'powershell', 'cmd'];
            const realLanguages = ['html', 'css', 'javascript', 'js', 'python', 'py', 'java', 'c', 'cpp', 'csharp', 'cs', 'go', 'rust', 'ruby', 'php', 'swift', 'kotlin', 'typescript', 'ts', 'sql', 'json', 'xml', 'yaml', 'markdown', 'md'];

            containerElement.querySelectorAll('pre').forEach(pre => {
                const codeEl = pre.querySelector('code');
                if (!codeEl) return;

                const codeContent = codeEl.innerText;
                const lineCount = codeContent.split('\n').length;
                const langMatch = codeEl.className.match(/language-(\S+)/);
                const lang = langMatch ? langMatch[1].toLowerCase() : 'plaintext';

                // --- Artifact Trigger Conditions ---
                if (lineCount > 7 && !shellLangs.includes(lang) && realLanguages.includes(lang)) {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'artifact-placeholder';
                    const artifactTitle = `${lang.charAt(0).toUpperCase() + lang.slice(1)} Code Snippet`;
                    placeholder.innerHTML = `
                        <div class="artifact-header">
                            <i class="artifact-icon fas fa-code"></i>
                            <div class="artifact-details">
                                <div class="title">${escapeHtml(artifactTitle)}</div>
                                <div class="description">${lineCount} lines of code. Click to view and interact.</div>
                            </div>
                        </div>
                        <div class="artifact-actions">
                            <button class="artifact-btn primary">
                                <i class="fas fa-external-link-alt"></i> View Code
                            </button>
                        </div>
                    `;
                    placeholder.querySelector('.artifact-btn').addEventListener('click', () => {
                        openArtifactModal('code', codeContent, artifactTitle, lang);
                    });
                    pre.parentNode.replaceChild(placeholder, pre);
                } else {
                    // --- Display as a normal, themed code block ---
                    pre.style.display = 'block';
                    pre.style.backgroundColor = 'var(--bg-secondary)';
                    pre.style.borderRadius = 'var(--radius-sm)';
                    pre.style.border = '1px solid var(--border-color)';
                    pre.style.padding = '15px';
                    pre.style.marginTop = '15px';
                    pre.style.position = 'relative';
                    pre.style.overflow = 'auto';

                    const copyBtn = document.createElement('button');
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                    copyBtn.title = 'Copy code';
                    copyBtn.style.cssText = `
                        position: absolute; top: 8px; right: 8px;
                        background: var(--bg-tertiary); color: var(--text-secondary);
                        border: 1px solid var(--border-color); border-radius: 999px;
                        padding: 5px 8px; cursor: pointer; transition: all 0.2s;
                        font-size: 12px; line-height: 1; opacity: 0;
                    `;
                    pre.onmouseover = () => copyBtn.style.opacity = '1';
                    pre.onmouseout = () => copyBtn.style.opacity = '0';
                    copyBtn.onclick = () => {
                        navigator.clipboard.writeText(codeContent).then(() => {
                            copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                            setTimeout(() => copyBtn.innerHTML = '<i class="fas fa-copy"></i>', 2000);
                        }).catch(err => console.error('Copy failed', err));
                    };
                    pre.appendChild(copyBtn);
                    Prism.highlightElement(codeEl);
                }
            });
        }
        
        function restructureMessageContent(messageElement) {
            // NEW: Prevent restructuring for special message types
            if (messageElement.classList.contains('is-stock-message') || messageElement.classList.contains('contains-edited-image')) {
                return;
            }

            const contentDiv = messageElement.querySelector('.message-content');
            if (!contentDiv) return;

            const artifacts = Array.from(contentDiv.querySelectorAll('.artifact-placeholder'));
            if (artifacts.length === 0) return;

            let hasTextContent = false;
            contentDiv.childNodes.forEach(node => {
                if (node.nodeType === 3 && node.textContent.trim() !== '') {
                    hasTextContent = true;
                } else if (node.nodeType === 1 && !node.classList.contains('artifact-placeholder') && !node.classList.contains('message-actions-bottom') && node.innerText && node.innerText.trim() !== '') {
                    hasTextContent = true;
                }
            });
            
            if (hasTextContent) {
                artifacts.forEach(artifactNode => {
                    const newMsg = createAiMessageContainer();
                    newMsg.contentDiv.appendChild(artifactNode);
                    messageElement.before(newMsg.element);
                    
                    const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.add('animate-in'); observer.unobserve(entry.target); } }); }, { threshold: 0.1 });
                    observer.observe(newMsg.element);
                });
            } 
        }

        function createAiMessageContainer() {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ai-message';
            msgDiv.id = `msg-${messageIdCounter++}`;
            const avatarContent = `<div class="logo-switch-icon" style="width: 18px; height: 18px; transform: rotate(-15deg); border-radius: 4px;"><div class="logo-switch-left"></div><div class="logo-switch-right"></div></div>`;
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            msgDiv.innerHTML = `<div class="message-header"><div class="message-avatar ai-avatar">${avatarContent}</div><span>SKYTH Engine</span></div>`;
            msgDiv.appendChild(contentDiv);
            return { element: msgDiv, contentDiv: contentDiv };
        }


        function createHtmlArtifact(messageElement, htmlCode, title) {
            const placeholder = document.createElement('div');
            placeholder.className = 'artifact-placeholder';
            placeholder.innerHTML = `
                <div class="artifact-header">
                    <i class="artifact-icon fas fa-cube"></i>
                    <div class="artifact-details">
                        <div class="title">${escapeHtml(title)}</div>
                        <div class="description">Click to view the interactive element and its source code.</div>
                    </div>
                </div>
                <div class="artifact-actions">
                    <button class="artifact-btn primary">
                        <i class="fas fa-play-circle"></i> View Artifact
                    </button>
                </div>
            `;
            placeholder.querySelector('.artifact-btn').addEventListener('click', () => {
                openArtifactModal('html', htmlCode, title);
            });
            messageElement.querySelector('.message-content').appendChild(placeholder);
        }
        
        function createImageArtifact(messageElement, imageData, title) {
             const placeholder = document.createElement('div');
            placeholder.className = 'artifact-placeholder';
            placeholder.innerHTML = `
                <div class="artifact-header">
                    <img src="${imageData}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;">
                    <div class="artifact-details">
                        <div class="title">${escapeHtml(title)}</div>
                        <div class="description">Generated or uploaded image. Click to view full size.</div>
                    </div>
                </div>
                <div class="artifact-actions">
                    <button class="artifact-btn primary">
                        <i class="fas fa-expand-arrows-alt"></i> View Full Size
                    </button>
                </div>
            `;
            placeholder.querySelector('.artifact-btn').addEventListener('click', () => {
                openInLightbox({ type: 'image', fullUrl: imageData });
            });
            messageElement.querySelector('.message-content').appendChild(placeholder);
        }

        function openArtifactModal(type, content, title, lang = 'html') {
            const modal = gebi('artifact-viewer-modal');
            
            document.body.classList.add('modal-open');

            const titleEl = modal.querySelector('.artifact-viewer-title');
            const tabsContainer = modal.querySelector('.artifact-viewer-tabs');
            const iframe = modal.querySelector('#artifact-iframe');
            const codeContentEl = modal.querySelector('#artifact-code-content');
            
            modal.dataset.codeContent = content;
            modal.dataset.codeLang = lang;
            modal.dataset.artifactTitle = title;

            titleEl.textContent = title;

            const editBtn = gebi('artifact-edit-btn');
            codeContentEl.contentEditable = false;
            editBtn.classList.remove('active');
            editBtn.innerHTML = '<i class="fas fa-pencil-alt"></i>';
            editBtn.title = 'Edit Code';

            if (type === 'html') {
                tabsContainer.style.display = 'flex';
                iframe.srcdoc = content;
                codeContentEl.textContent = content;
                codeContentEl.className = `language-html`;
                Prism.highlightElement(codeContentEl);
                switchArtifactTab('preview');
            } else { // type === 'code'
                tabsContainer.style.display = 'none';
                iframe.srcdoc = '';
                codeContentEl.textContent = content;
                codeContentEl.className = `language-${lang}`;
                Prism.highlightElement(codeContentEl);
                switchArtifactTab('code');
            }
            
            modal.style.display = 'flex';
        }

        function switchArtifactTab(tabName) {
            const previewPane = gebi('artifact-preview-pane');
            const codePane = gebi('artifact-code-pane');
            const previewTabBtn = gebi('artifact-viewer-modal').querySelector('[data-tab="preview"]');
            const codeTabBtn = gebi('artifact-viewer-modal').querySelector('[data-tab="code"]');
            
            if (tabName === 'preview') {
                previewPane.classList.add('active');
                codePane.classList.remove('active');
                previewTabBtn.classList.add('active');
                codeTabBtn.classList.remove('active');
            } else {
                previewPane.classList.remove('active');
                codePane.classList.add('active');
                previewTabBtn.classList.remove('active');
                codeTabBtn.classList.add('active');
            }
        }
        
        function escapeHtml(text) { if (typeof text !== 'string') return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        
        function scrollToBottom() { window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }
        
        async function fetchPopularTopics() { try { const response = await fetch('/popular_topics'); const topics = await response.json(); const grid = gebi('popular-topics-grid'); grid.innerHTML = ''; topics.forEach(topic => { const btn = document.createElement('button'); btn.className = 'topic-chip'; btn.dataset.topic = topic.title; btn.textContent = escapeHtml(topic.title); btn.onclick = () => handlePopularTopicClick(btn); grid.appendChild(btn); }); } catch(e) { gebi('popular-topics-grid').innerHTML = '<div style="color: var(--text-muted);">Could not load topics.</div>'; } }
        
        function handlePopularTopicClick(buttonElement) { const topicTitle = buttonElement.dataset.topic; initialSearchInput.value = topicTitle; handleInitialSearch(); }
        
        function showStatus(message, type = 'info', duration = 3000) { statusBar.textContent = message; statusBar.className = `status-bar active ${type}`; setTimeout(() => statusBar.classList.remove('active'), duration); }
        
        function toggleGodMode() { isGodMode = !isGodMode; godModeSwitch.classList.toggle('active', isGodMode); godModeLabel.textContent = isGodMode ? 'God Mode ON' : 'God Mode OFF'; showStatus(isGodMode ? 'God Mode activated' : 'God Mode deactivated', isGodMode ? 'success' : 'info'); if (isGodMode) { const storedKey = localStorage.getItem('openRouterApiKey'); if (storedKey) { userOpenRouterApiKey = storedKey; showStatus('Using stored OpenRouter API Key.', 'info'); } else { const key = prompt("God Mode requires an OpenRouter API Key. Please enter yours (it will be stored in your browser's local storage):"); if (key) { userOpenRouterApiKey = key.trim(); localStorage.setItem('openRouterApiKey', userOpenRouterApiKey); showStatus('OpenRouter API Key saved and activated for God Mode.', 'success'); } else { isGodMode = false; godModeSwitch.classList.remove('active'); godModeLabel.textContent = 'God Mode OFF'; showStatus('God Mode deactivated: No API Key provided.', 'warning'); } } } }

        // --- Animation & Effects Logic ---
        let scene, camera, renderer, particleSystem, animatedShapes = [];
        function initThreeJS() {
            const canvas = gebi('three-background');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1000);
            renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 0);

            const particleCount = 100;
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);
            for (let i = 0; i < particleCount * 3; i++) {
                positions[i] = (Math.random() - 0.5) * 2000;
            }
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            
            const particleMaterial = new THREE.PointsMaterial({ size: 2, transparent: true, opacity: 0.6, blending: THREE.AdditiveBlending });
            particleSystem = new THREE.Points(geometry, particleMaterial);
            scene.add(particleSystem);
            
            camera.position.z = 1000;
            
            for (let i = 0; i < 10; i++) {
                const shapeGeometry = new THREE.BoxGeometry(20, 20, 20);
                const shapeMaterial = new THREE.MeshBasicMaterial({ transparent: true, opacity: 0.1, wireframe: true });
                const cube = new THREE.Mesh(shapeGeometry, shapeMaterial);
                cube.position.set((Math.random() - 0.5) * 1000, (Math.random() - 0.5) * 1000, (Math.random() - 0.5) * 1000);
                scene.add(cube);
                animatedShapes.push(cube);
            }

            function animate() {
                requestAnimationFrame(animate);
                const positions = particleSystem.geometry.attributes.position.array;
                for (let i = 0; i < positions.length; i += 3) {
                    positions[i+1] -= 0.5;
                    if (positions[i+1] < -1000) positions[i+1] = 1000;
                }
                particleSystem.geometry.attributes.position.needsUpdate = true;
                particleSystem.rotation.y += 0.0005;
                animatedShapes.forEach((shape, index) => {
                    shape.rotation.x += 0.005 + index * 0.0001;
                    shape.rotation.y += 0.005 + index * 0.0001;
                });
                renderer.render(scene, camera);
            }
            animate();
            updateThreeJSColors();
        }

        function updateThreeJSColors() {
            const style = getComputedStyle(document.documentElement);
            const particleColor = new THREE.Color(style.getPropertyValue('--accent-primary').trim());
            const shapeColor = new THREE.Color(style.getPropertyValue('--accent-secondary').trim());
            if (particleSystem) { particleSystem.material.color.set(particleColor); }
            if (animatedShapes.length > 0) { animatedShapes.forEach(shape => shape.material.color.set(shapeColor)); }
        }

        function createFloatingParticles() { for (let i = 0; i < 15; i++) { const particle = document.createElement('div'); particle.className = 'particle'; particle.style.left = Math.random() * 100 + '%'; particle.style.top = Math.random() * 100 + '%'; particle.style.animationDelay = Math.random() * 3 + 's'; document.body.appendChild(particle); } }
        function createRipple(event) { const button = event.currentTarget; const circle = document.createElement("span"); const diameter = Math.max(button.clientWidth, button.clientHeight); const radius = diameter / 2; circle.style.width = circle.style.height = `${diameter}px`; circle.style.left = `${event.clientX - button.getBoundingClientRect().left - radius}px`; circle.style.top = `${event.clientY - button.getBoundingClientRect().top - radius}px`; circle.classList.add("ripple"); const ripple = button.getElementsByClassName("ripple")[0]; if (ripple) { ripple.remove(); } button.appendChild(circle); }

        // --- Personalization & Settings ---
        const themes = {
            default: { name: 'Default', colors: { '--bg-primary': '#0a0a0a', '--bg-secondary': '#111111', '--bg-tertiary': '#1a1a1a', '--text-primary': '#eaeaea', '--text-secondary': '#a0a0a0', '--text-muted': '#666666', '--accent-primary': '#00d4ff', '--accent-secondary': '#00ffaa', '--border-color': '#2a2a2a', '--shadow': '0 8px 32px rgba(0,0,0,0.4)', '--accent-glow': 'rgba(0, 212, 255, 0.2)' } },
            synthwave: { name: 'Synthwave', colors: { '--bg-primary': '#0d021a', '--bg-secondary': '#1a0d2b', '--bg-tertiary': '#2c1b42', '--text-primary': '#f0e8ff', '--text-secondary': '#a899c2', '--text-muted': '#7a6a91', '--accent-primary': '#ff00ff', '--accent-secondary': '#ff4f4f', '--border-color': '#422d61', '--shadow': '0 8px 32px rgba(0,0,0,0.5)', '--accent-glow': 'rgba(255, 0, 255, 0.3)' } },
            sunset: { name: 'Sunset', colors: { '--bg-primary': '#1A1D2D', '--bg-secondary': '#2A2D40', '--bg-tertiary': '#3A3D52', '--text-primary': '#FADBC5', '--text-secondary': '#B3A69A', '--text-muted': '#8a7e74', '--accent-primary': '#FF8C64', '--accent-secondary': '#FFB399', '--border-color': '#4a4d62', '--shadow': '0 8px 32px rgba(0,0,0,0.4)', '--accent-glow': 'rgba(255, 140, 100, 0.25)' } },
            forest: { name: 'Forest', colors: { '--bg-primary': '#192823', '--bg-secondary': '#223831', '--bg-tertiary': '#2B483F', '--text-primary': '#DCEEE9', '--text-secondary': '#8DAE9F', '--text-muted': '#6a8e7f', '--accent-primary': '#48A9A6', '--accent-secondary': '#92D2C8', '--border-color': '#3a584f', '--shadow': '0 8px 32px rgba(0,0,0,0.4)', '--accent-glow': 'rgba(72, 169, 166, 0.25)' } },
            abyss: { name: 'Abyss', colors: { '--bg-primary': '#0D0D21', '--bg-secondary': '#1A1A36', '--bg-tertiary': '#27274B', '--text-primary': '#E0E0FF', '--text-secondary': '#8F8FB2', '--text-muted': '#6f6f92', '--accent-primary': '#8A2BE2', '--accent-secondary': '#C71585', '--border-color': '#3a3a5b', '--shadow': '0 8px 32px rgba(0,0,0,0.4)', '--accent-glow': 'rgba(138, 43, 226, 0.25)' } },
            sakura: { name: 'Sakura', colors: { '--bg-primary': '#fdfafd', '--bg-secondary': '#f9f5f9', '--bg-tertiary': '#f2eef2', '--text-primary': '#211a21', '--text-secondary': '#6d5f6d', '--text-muted': '#998f99', '--accent-primary': '#e169a3', '--accent-secondary': '#a968c0', '--border-color': '#e0d8e0', '--shadow': '0 8px 24px rgba(100,80,100,0.15)', '--accent-glow': 'rgba(225, 105, 163, 0.25)' } },
        };

        function applyTheme(themeName) {
            const theme = themes[themeName] || themes.default;
            const root = document.documentElement;
            Object.entries(theme.colors).forEach(([key, value]) => {
                root.style.setProperty(key, value);
            });
            root.style.setProperty('--logo-color-left', theme.colors['--accent-primary']);
            root.style.setProperty('--logo-color-right', theme.colors['--accent-secondary']);
            updateThreeJSColors();
            
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.theme === themeName);
            });
        }

        function applyAllBackgrounds() {
            const imageUrlData = localStorage.getItem('skyth_image_bg_data') || '';
            const videoUrl = videoBackground.src;

            document.body.style.backgroundImage = 'none';
            videoBackground.classList.remove('active');
            gebi('three-background').style.opacity = '1';

            if (imageUrlData) {
                document.body.style.backgroundImage = `url('${imageUrlData}')`;
                gebi('three-background').style.opacity = '0';
                videoBackground.pause();
            } else if (videoUrl && videoUrl !== window.location.href) {
                videoBackground.classList.add('active');
                videoBackground.play().catch(e => console.error("Video autoplay failed:", e));
                gebi('three-background').style.opacity = '0';
            } else {
                gebi('three-background').style.opacity = '1';
                videoBackground.pause();
            }
        }
        
        function updateAllUserAvatarsOnPage(picData) {
            const pfpPreview = gebi('pfp-preview');
            if (pfpPreview) { pfpPreview.src = picData || ''; }
            const profileBtn = gebi('profile-btn');
            if (picData) {
                profileBtn.innerHTML = '';
                profileBtn.style.backgroundImage = `url('${picData}')`;
            } else {
                profileBtn.style.backgroundImage = 'none';
                profileBtn.innerHTML = '<i class="fas fa-user-circle"></i>';
            }
            document.querySelectorAll('.message-avatar.user-avatar').forEach(avatar => {
                if (picData) {
                    avatar.style.backgroundImage = `url('${picData}')`;
                    avatar.textContent = '';
                } else {
                    avatar.style.backgroundImage = 'none';
                    avatar.textContent = currentUser ? currentUser.charAt(0).toUpperCase() : 'U';
                }
            });
        }

        function loadSettings() {
            gebi('username-change-input').value = currentUser || '';
            userProfilePic = localStorage.getItem('skyth_user_pfp');
            updateAllUserAvatarsOnPage(userProfilePic);
            permanentCustomPersonaPrompt = localStorage.getItem('skyth_permanent_persona') || '';
            gebi('permanent-custom-persona-input').value = permanentCustomPersonaPrompt;
            const savedTheme = localStorage.getItem('skyth_theme') || 'default';
            applyTheme(savedTheme);
            applyAllBackgrounds();
            
            // Removed ElevenLabs API key loading as requested
        }

        function populateThemeSelector() {
            const container = gebi('theme-selector-container');
            container.innerHTML = '';
            Object.entries(themes).forEach(([key, theme]) => {
                const option = document.createElement('div');
                option.className = 'theme-option';
                option.dataset.theme = key;
                let deleteHintHtml = key.startsWith('custom-') ? `<div class="delete-hint"><i class="fas fa-trash-alt"></i></div>` : '';
                option.innerHTML = `<span>${escapeHtml(theme.name)}</span><div class="theme-preview"><div class="theme-preview-dot" style="background: ${theme.colors['--accent-primary']}"></div><div class="theme-preview-dot" style="background: ${theme.colors['--accent-secondary']}"></div><div class="theme-preview-dot" style="background: ${theme.colors['--bg-secondary']}"></div></div>${deleteHintHtml}`;
                option.addEventListener('click', () => { applyTheme(key); localStorage.setItem('skyth_theme', key); showStatus(`${theme.name} theme applied!`, 'success'); });

                if (key.startsWith('custom-')) {
                    const deleteAction = () => { if (confirm(`Are you sure you want to delete the theme "${theme.name}"?`)) { delete themes[key]; delete customThemes[key]; localStorage.setItem('skyth_custom_themes', JSON.stringify(customThemes)); if (localStorage.getItem('skyth_theme') === key) { localStorage.setItem('skyth_theme', 'default'); applyTheme('default'); } populateThemeSelector(); showStatus(`Theme "${theme.name}" deleted.`, 'info'); } };
                    option.addEventListener('contextmenu', (e) => { e.preventDefault(); deleteAction(); });
                }
                container.appendChild(option);
            });
            
            const addButton = document.createElement('div');
            addButton.className = 'theme-option';
            addButton.style.cssText = 'text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center;';
            addButton.innerHTML = `<i class="fas fa-plus" style="font-size: 20px; margin-bottom: 8px;"></i><span>New Theme</span>`;
            addButton.addEventListener('click', () => {
                gebi('custom-theme-name').value = '';
                if (!colorPickers['accent1-picker']) { initColorPicker('accent1-picker', '#00d4ff'); initColorPicker('accent2-picker', '#00ffaa'); initColorPicker('bg1-picker', '#0a0a0a'); }
                else { colorPickers['accent1-picker'].setHex('#00d4ff'); colorPickers['accent2-picker'].setHex('#00ffaa'); colorPickers['bg1-picker'].setHex('#0a0a0a'); }
                gebi('theme-engine-modal').style.display = 'flex';
                document.body.classList.add('modal-open'); // Prevent background scroll
            });
            container.appendChild(addButton);
            
            const currentTheme = localStorage.getItem('skyth_theme') || 'default';
            const activeOption = container.querySelector(`.theme-option[data-theme="${currentTheme}"]`);
            if (activeOption) activeOption.classList.add('active');
        }

        // --- DOMContentLoaded Initializer ---
        document.addEventListener('DOMContentLoaded', () => { 
            const savedCustomThemes = JSON.parse(localStorage.getItem('skyth_custom_themes') || '{}');
            customThemes = savedCustomThemes;
            Object.assign(themes, customThemes);

            checkAuthentication();
            fetchPopularTopics();
            initThreeJS();
            createFloatingParticles();

            // --- Event Listeners Setup ---
            gebi('login-form').addEventListener('submit', handleLogin);
            gebi('logout-btn').addEventListener('click', handleLogout);
            initialSearchButton.addEventListener('click', handleInitialSearch);
            initialSearchInput.addEventListener('keypress', handleInitialKeyPress);
            chatButton.addEventListener('click', performChatSearch);
            chatInput.addEventListener('keypress', handleChatKeyPress);
            chatInput.addEventListener('input', () => { 
                const maxHeight = 200; // Match CSS max-height
                chatInput.style.height = 'auto'; 
                const newHeight = chatInput.scrollHeight; 
                if (newHeight > maxHeight) { 
                    chatInput.style.height = `${maxHeight}px`; 
                    chatInput.style.overflowY = 'auto'; 
                } else { 
                    chatInput.style.height = `${newHeight}px`; 
                    chatInput.style.overflowY = 'hidden'; 
                } 
            });
            
            scrollToBottomBtn.addEventListener('click', scrollToBottom);
            window.addEventListener('scroll', () => { scrollToBottomBtn.style.display = (window.scrollY + window.innerHeight < document.body.scrollHeight - 200) ? 'block' : 'none'; });
            
            personaButtons.forEach(button => button.addEventListener('click', () => { 
                personaButtons.forEach(btn => btn.classList.remove('active')); 
                button.classList.add('active'); 
                currentPersona = button.dataset.persona; 
                if (currentPersona === 'unhinged') { showStatus('WARNING: Unhinged persona activated. Responses may be unpredictable and offensive.', 'error', 5000); }
                else if (currentPersona === 'custom' && !permanentCustomPersonaPrompt) { showStatus('Custom persona is empty. Please set it in your profile.', 'warning'); }
                else { showStatus(`Persona: ${button.textContent}`, 'info'); } 
            }));
            
            gebi('controls-toggle-btn').addEventListener('click', (e) => { gebi('header-controls-wrapper').classList.toggle('open'); e.currentTarget.classList.toggle('open'); });
            
            // Multimodal Input Setup
            multimodalToggle.addEventListener('click', (e) => { 
                e.stopPropagation(); 
                multimodalMenu.classList.toggle('active'); 
                multimodalToggle.classList.toggle('active'); // Toggle plus to X animation
            });
            document.addEventListener('click', (e) => { 
                if (!multimodalToggle.contains(e.target) && !multimodalMenu.contains(e.target)) { 
                    multimodalMenu.classList.remove('active'); 
                    multimodalToggle.classList.remove('active'); // Reset plus to X animation
                } 
            });

            voiceOption.addEventListener('click', () => { multimodalMenu.classList.remove('active'); multimodalToggle.classList.remove('active'); openVoiceChat(); });
            voiceVisualizer.addEventListener('click', () => { if (isRecording) { stopVoiceRecording(); } else { startVoiceRecording(); } });
            voiceChatModal.querySelector('.modal-close-btn').addEventListener('click', closeVoiceChat);

            imageUploadOption.addEventListener('click', () => { hiddenImageInput.click(); multimodalMenu.classList.remove('active'); multimodalToggle.classList.remove('active'); });
            hiddenImageInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleImageSelection(e.target.files[0]); });
            removeImageBtn.addEventListener('click', removeImagePreview);

            fileUploadOption.addEventListener('click', () => { hiddenFileInput.click(); multimodalMenu.classList.remove('active'); multimodalToggle.classList.remove('active'); });
            hiddenFileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFileSelection(e.target.files[0]); });
            removeFileBtn.addEventListener('click', removeFilePreview);

            gebi('camera-option').addEventListener('click', () => { showStatus('Camera feature coming soon!', 'info'); multimodalMenu.classList.remove('active'); multimodalToggle.classList.remove('active'); });
            
            // Settings & Modals
            document.querySelectorAll('.modal-overlay .modal-close-btn:not(#artifact-viewer-close-btn):not(#discover-modal-close-btn):not(#voice-chat-modal .modal-close-btn)').forEach(btn => btn.addEventListener('click', (e) => {
                e.target.closest('.modal-overlay').style.display = 'none';
                document.body.classList.remove('modal-open'); // Allow background scroll
            }));
            gebi('profile-btn').addEventListener('click', () => {
                gebi('settings-modal').style.display = 'flex';
                document.body.classList.add('modal-open'); // Prevent background scroll
            });
            populateThemeSelector();
            gebi('username-change-input').addEventListener('change', (e) => { const n = e.target.value.trim(); if(n){currentUser=n; localStorage.setItem('skyth_username',n); updateGreeting();showStatus('Username updated!','success');}});
            gebi('permanent-custom-persona-input').addEventListener('change', (e) => { permanentCustomPersonaPrompt=e.target.value; localStorage.setItem('skyth_permanent_persona',e.target.value); showStatus('Permanent custom persona saved!','success');});
            gebi('profile-pic-upload').addEventListener('change', (e) => { const f=e.target.files[0]; if(f&&f.type.startsWith('image/')){const r=new FileReader();r.onload=(ev)=>{userProfilePic=ev.target.result;localStorage.setItem('skyth_user_pfp',userProfilePic);updateAllUserAvatarsOnPage(userProfilePic);showStatus('Profile picture updated!','success');};r.readAsDataURL(f);}});
            gebi('video-bg-upload').addEventListener('change', (e)=>{const f=e.target.files[0];if(f&&f.type==='video/mp4'){if(videoBackground.src&&videoBackground.src.startsWith('blob:')){URL.revokeObjectURL(videoBackground.src);}videoBackground.src=URL.createObjectURL(f);localStorage.removeItem('skyth_image_bg_data');applyAllBackgrounds();showStatus('Video background set for this session.','success');}else if(f){showStatus('Please select a .mp4 video file.','error');}});
            gebi('clear-video-bg-btn').addEventListener('click',()=>{if(videoBackground.src&&videoBackground.src.startsWith('blob:')){URL.revokeObjectURL(videoBackground.src);}videoBackground.src='';applyAllBackgrounds();showStatus('Video background cleared.','info');});
            gebi('image-bg-upload').addEventListener('change', (e)=>{const f=e.target.files[0];if(f&&f.type.startsWith('image/')){const r=new FileReader();r.onload=(ev)=>{localStorage.setItem('skyth_image_bg_data',ev.target.result);applyAllBackgrounds();showStatus('Image background updated!','success');};r.readAsDataURL(f);}});
            gebi('clear-image-bg-btn').addEventListener('click',()=>{localStorage.removeItem('skyth_image_bg_data');applyAllBackgrounds();showStatus('Image background cleared!','info');});
            // Removed ElevenLabs API Key input change listener as requested
            gebi('god-mode-toggle').addEventListener('click', () => { toggleGodMode(); anime({ targets: godModeSwitch, scale: [1, 1.2, 1], duration: 400, easing: 'easeOutElastic(1, .8)' }); });
            
            anime({ targets: '.persona-btn', opacity: [0, 1], translateY: [10, 0], delay: anime.stagger(100, {start: 600}), duration: 800, easing: 'easeOutElastic(1, .8)' });
            document.querySelectorAll('button, .header-btn, .suggestion-item, .topic-chip, .tab-btn, .news-card-action-btn, .artifact-btn').forEach(btn => btn.addEventListener("click", createRipple));
            
            // Intersection Observer for message animations
            const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.add('animate-in'); observer.unobserve(entry.target); } }); }, { threshold: 0.1 });
            const originalAddMessage = addMessageToConversation;
            addMessageToConversation = (text, sender, isStreaming = false, imageData = null, fileData = null, fileName = null) => { 
                const msgEl = originalAddMessage(text, sender, isStreaming, imageData, fileData, fileName); 
                observer.observe(msgEl); 
                return msgEl; 
            };
        
            // Theme Engine Modal
            gebi('save-custom-theme-btn').addEventListener('click', () => {
                const name = gebi('custom-theme-name').value.trim(); if (!name) { showStatus('Please enter a theme name.', 'error'); return; }
                const key = 'custom-' + name.toLowerCase().replace(/\s+/g, '-'); if (themes[key]) { showStatus('A theme with this name already exists.', 'error'); return; }
                const accent1 = colorPickers['accent1-picker'].getHex(), accent2 = colorPickers['accent2-picker'].getHex(), bg1 = colorPickers['bg1-picker'].getHex();
                const newTheme = { name, colors: generateThemePalette(accent1, accent2, bg1) };
                customThemes[key] = newTheme; themes[key] = newTheme; localStorage.setItem('skyth_custom_themes', JSON.stringify(customThemes));
                applyTheme(key); localStorage.setItem('skyth_theme', key);
                populateThemeSelector(); showStatus(`Theme "${name}" created and applied!`, 'success'); gebi('theme-engine-modal').style.display = 'none';
                document.body.classList.remove('modal-open'); // Allow background scroll
            });

            // Discover Page Listeners
            gebi('discover-btn').addEventListener('click', showDiscoverPage);
            gebi('logo').addEventListener('click', (e) => { e.preventDefault(); showMainSearch(); });
            gebi('discover-modal-close-btn').addEventListener('click', closeDiscoverArticle);

            // Lightbox Close
            gebi('media-lightbox').querySelector('.lightbox-close').onclick = () => { 
                const lb = gebi('media-lightbox'); 
                lb.style.display="none"; 
                gebi('lightbox-img').src=""; 
                gebi('lightbox-video').pause(); 
                gebi('lightbox-video').src=""; 
                gebi('lightbox-iframe').src=""; 
                document.body.classList.remove('modal-open'); // Allow background scroll
            };

            // Artifact Viewer Listeners
            gebi('artifact-viewer-modal').querySelectorAll('.artifact-tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchArtifactTab(btn.dataset.tab));
            });
            // FIX: Specific close handler for artifact viewer to manage body class
            gebi('artifact-viewer-close-btn').addEventListener('click', () => {
                const modal = gebi('artifact-viewer-modal');
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                }
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
            });
            setupArtifactViewerActions();

            // Easter Egg
            let pfpTapCount = 0; let pfpTapTimeout;
            gebi('pfp-preview').addEventListener('click', () => { pfpTapCount++; clearTimeout(pfpTapTimeout); pfpTapTimeout = setTimeout(() => { pfpTapCount = 0; }, 1000); if (pfpTapCount === 7) { pfpTapCount = 0; showStatus('Never gonna give you up...', 'info'); openInLightbox({type: 'video', videoId: 'dQw4w9WgXcQ'}); } });
        });
        
        function setupArtifactViewerActions() {
            const modal = gebi('artifact-viewer-modal');
            const copyBtn = gebi('artifact-copy-btn');
            const editBtn = gebi('artifact-edit-btn');
            const saveBtn = gebi('artifact-save-btn');
            const fullscreenBtn = gebi('artifact-fullscreen-btn');
            const codeContentEl = gebi('artifact-code-content');

            copyBtn.onclick = () => {
                navigator.clipboard.writeText(codeContentEl.innerText).then(() => {
                    showStatus('Code copied!', 'success');
                });
            };

            editBtn.onclick = () => {
                const isEditing = codeContentEl.isContentEditable;
                codeContentEl.contentEditable = !isEditing;
                editBtn.classList.toggle('active', !isEditing);
                if (!isEditing) {
                    editBtn.innerHTML = '<i class="fas fa-check"></i>';
                    editBtn.title = 'Done Editing';
                    codeContentEl.focus();
                    // Disable Prism's real-time highlighting during edit for performance
                    codeContentEl.classList.add('no-highlight');
                } else {
                    editBtn.innerHTML = '<i class="fas fa-pencil-alt"></i>';
                    editBtn.title = 'Edit Code';
                    // Update the stored content and re-render the preview iframe
                    const newCode = codeContentEl.innerText;
                    modal.dataset.codeContent = newCode;
                    gebi('artifact-iframe').srcdoc = newCode;
                    codeContentEl.classList.remove('no-highlight');
                    Prism.highlightElement(codeContentEl); // Re-highlight after editing
                }
            };

            saveBtn.onclick = () => {
                const content = modal.dataset.codeContent;
                const lang = modal.dataset.codeLang;
                const title = modal.dataset.artifactTitle;
                const langExtMap = {
                    'html': 'html', 'javascript': 'js', 'css': 'css', 'python': 'py', 'java': 'java', 'csharp': 'cs', 'cpp': 'cpp', 'ruby': 'rb', 'go': 'go', 'rust': 'rs', 'typescript': 'ts', 'json': 'json', 'xml': 'xml', 'markdown': 'md'
                };
                const extension = langExtMap[lang] || 'txt';
                const filename = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.${extension}`;

                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            };

            fullscreenBtn.onclick = () => {
                if (!document.fullscreenElement) {
                    modal.requestFullscreen().catch(err => {
                        alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                    });
                } else {
                    document.exitFullscreen();
                }
            };

            document.addEventListener('fullscreenchange', () => {
                const isFullscreen = !!document.fullscreenElement;
                fullscreenBtn.innerHTML = isFullscreen ? '<i class="fas fa-compress"></i>' : '<i class="fas fa-expand"></i>';
                fullscreenBtn.title = isFullscreen ? "Exit Fullscreen" : "Toggle Fullscreen";
            });
        }

        // --- NEW DISCOVER PAGE LOGIC ---
        function showDiscoverPage() {
            mainContentWrapper.style.display = 'none';
            discoverPage.style.display = 'flex';
            document.body.classList.remove('modal-open'); // Ensure body can scroll if discover content is larger
            if (!isDiscoverInitialized) {
                renderDiscoverNav();
                loadDiscoverCategory(currentDiscoverCategory);
                isDiscoverInitialized = true;
            }
        }

        function showMainSearch() {
            discoverPage.style.display = 'none';
            mainContentWrapper.style.display = 'flex';
            document.body.classList.remove('modal-open'); // Ensure body can scroll if main content is larger
        }

        function renderDiscoverNav() {
            const nav = gebi('discover-category-nav');
            const categories = ["For You", "Sports", "Entertainment", "Technology", "Top", "Around the World", "Science", "Business"];
            nav.innerHTML = categories.map(cat =>
                `<a class="nav-link ${cat === currentDiscoverCategory ? 'active' : ''}" data-category="${cat}">${cat}</a>`
            ).join('');
            nav.addEventListener('click', e => {
                if (e.target.classList.contains('nav-link')) {
                    const category = e.target.dataset.category;
                    if (category !== currentDiscoverCategory) {
                        currentDiscoverCategory = category;
                        nav.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
                        e.target.classList.add('active');
                        loadDiscoverCategory(category);
                    }
                }
            });
        }
        
        async function loadDiscoverCategory(category) {
            const feed = gebi('discover-card-feed');
            feed.innerHTML = '<div class="center-message-container"><div class="loader"></div></div>';
            try {
                const response = await fetch(`/fetch_articles/${category}`);
                if (!response.ok) throw new Error('Network error');
                const articles = await response.json();
                renderDiscoverFeed(articles.filter(a => a.title && a.snippet && a.url));
            } catch (error) {
                console.error('Failed to load discover articles:', error);
                feed.innerHTML = '<div class="center-message-container"><p>Failed to load articles.</p></div>';
            }
        }

        function renderDiscoverFeed(articles) {
            const feed = gebi('discover-card-feed');
            feed.innerHTML = '';
            if (articles.length === 0) {
                feed.innerHTML = '<div class="center-message-container"><p>No articles found.</p></div>';
                return;
            }
            articles.forEach(article => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <img class="card-thumbnail" src="${article.thumbnail || `https://via.placeholder.com/400x225/1e1e1e/888888?text=${encodeURIComponent(article.source || 'News')}`}" alt="${escapeHtml(article.title)}" onError="this.onerror=null;this.src='https://via.placeholder.com/400x225/1e1e1e/888888?text=Image+Error';">
                    <div class="card-content">
                        <h2>${escapeHtml(article.title)}</h2>
                        <p>${escapeHtml(article.snippet)}</p>
                        <span class="card-source">${escapeHtml(article.source || 'Unknown Source')}</span>
                    </div>
                `;
                card.addEventListener('click', () => {
                    fetch('/track_interaction', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ category: article.category })
                    }).catch(err => console.warn('Could not track interaction:', err));
                    openDiscoverArticle(article);
                });
                feed.appendChild(card);
            });

            anime({
                targets: '#discover-card-feed .card',
                opacity: [0, 1],
                scale: [0.95, 1],
                translateY: [30, 0],
                delay: anime.stagger(70),
                duration: 600,
                easing: 'easeOutCubic'
            });
        }

        async function openDiscoverArticle(article) {
            const modal = gebi('discover-article-modal');
            modal.style.visibility = 'visible';
            document.body.classList.add('modal-open'); // Prevent background scroll
            anime({ targets: modal, translateY: ['100%', '0%'], easing: 'easeOutExpo', duration: 400 });

            const contentArea = modal.querySelector('.discover-modal-content-area');
            contentArea.innerHTML = '<div class="center-message-container"><div class="loader"></div></div>';
            
            try {
                const response = await fetch('/get_full_article', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: article.url })
                });
                const content = await response.json();
                contentArea.innerHTML = `
                    ${content.image ? `<img src="${escapeHtml(content.image)}" alt="${escapeHtml(content.title)}">` : ''}
                    <h1>${escapeHtml(content.title)}</h1>
                    <p class="${!response.ok ? 'error-text' : ''}">${escapeHtml(content.text)}</p>
                `;
            } catch(error) {
                 contentArea.innerHTML = `<h1>Error</h1><p class="error-text">Failed to load article content.</p>`;
            }
        }

        function closeDiscoverArticle() {
             const modal = gebi('discover-article-modal');
             anime({
                targets: modal,
                translateY: ['0%', '100%'],
                easing: 'easeInExpo',
                duration: 400,
                complete: () => {
                    modal.style.visibility = 'hidden';
                    modal.querySelector('.discover-modal-content-area').innerHTML = '';
                    document.body.classList.remove('modal-open'); // Allow background scroll
                }
            });
        }
        
        // --- Media Lightbox ---
        function openInLightbox(item) {
            const lightbox = gebi('media-lightbox'), img = gebi('lightbox-img'), video = gebi('lightbox-video'), iframeContainer = gebi('lightbox-iframe-container'), iframe = gebi('lightbox-iframe');
            img.style.display = 'none'; video.style.display = 'none'; iframeContainer.style.display = 'none';
            if (item.type === 'video' && item.videoId) { iframe.src = `https://www.youtube.com/embed/${item.videoId}?autoplay=1`; iframeContainer.style.display = 'flex'; }
            else if (item.type === 'image') { img.src = item.fullUrl; img.style.display = 'block'; }
            else { video.src = item.fullUrl; video.style.display = 'block'; video.play(); }
            lightbox.style.display = "flex";
            document.body.classList.add('modal-open'); // Prevent background scroll
        }
        function displayMediaResults(messageElement, mediaData, title, type) {
            if (!messageElement || !mediaData || mediaData.length === 0) return;
            const details = createCollapsibleSection(messageElement, title, `${type}-search-details`);
            const contentDiv = details.querySelector('.details-content');
            contentDiv.innerHTML = ''; 
            const gridContainer = document.createElement('div');
            gridContainer.className = (type === 'image') ? 'image-results-grid' : 'video-results-grid';
            mediaData.forEach(item => {
                const mediaItemDiv = document.createElement('div');
                mediaItemDiv.className = 'media-item';
                mediaItemDiv.title = escapeHtml(item.title);
                mediaItemDiv.addEventListener('click', () => openInLightbox({ type, fullUrl: item.image_url || item.url, videoId: item.video_id }));
                mediaItemDiv.innerHTML = `<img src="${escapeHtml(item.thumbnail_url)}" alt="${escapeHtml(item.title)}" loading="lazy"><div class="media-item-title">${escapeHtml(item.title)}</div>`;
                gridContainer.appendChild(mediaItemDiv);
            });
            contentDiv.appendChild(gridContainer);
            details.open = true;
        }

        // --- Image & File Upload Logic ---
        function handleImageSelection(file) {
            if (!file || !file.type.startsWith('image/')) return;
            removeFilePreview(); // Ensure only one attachment type
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64String = e.target.result.split(',')[1];
                attachedImageData = base64String;
                displayImagePreview(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function handleFileSelection(file) {
            if (!file) return;
            removeImagePreview(); // Ensure only one attachment type
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64String = e.target.result.split(',')[1];
                attachedFileData = base64String;
                attachedFileName = file.name;
                displayFilePreview(file.name);
            };
            reader.readAsDataURL(file);
        }

        function displayImagePreview(dataUrl) {
            imagePreviewThumbnail.src = dataUrl;
            imagePreviewContainer.style.display = 'flex';
        }

        function displayFilePreview(fileName) {
            filePreviewName.textContent = fileName;
            filePreviewContainer.style.display = 'flex';
        }

        function removeImagePreview() {
            attachedImageData = null;
            imagePreviewContainer.style.display = 'none';
            imagePreviewThumbnail.src = '';
            hiddenImageInput.value = '';
        }

        function removeFilePreview() {
            attachedFileData = null;
            attachedFileName = null;
            filePreviewContainer.style.display = 'none';
            filePreviewName.textContent = '';
            hiddenFileInput.value = '';
        }

        // --- Theme Engine Helpers ---
        function initColorPicker(containerId,initialHex){const c=gebi(containerId);if(!c)return;c.innerHTML=`<div class="color-picker-ui"><canvas class="color-picker-sv-canvas"></canvas><canvas class="color-picker-hue-canvas"></canvas></div><div class="color-picker-controls"><div class="color-picker-preview"></div><input type="text" class="color-picker-hex-input" maxlength="7"></div>`;const sC=c.querySelector('.color-picker-sv-canvas'),hC=c.querySelector('.color-picker-hue-canvas'),pE=c.querySelector('.color-picker-preview'),hI=c.querySelector('.color-picker-hex-input'),sX=sC.getContext('2d',{willReadFrequently:!0}),hX=hC.getContext('2d');sC.width=240,sC.height=160,hC.width=30,hC.height=160;let state={h:0,s:1,v:1},svMarkerPos={x:sC.width,y:0},hueMarkerY=0;function drawHue(){const g=hX.createLinearGradient(0,0,0,hC.height);for(let i=0;i<=1;i+=.016)g.addColorStop(i,`hsl(${i*360}, 100%, 50%)`);hX.fillStyle=g,hX.fillRect(0,0,hC.width,hC.height),hX.strokeStyle='white',hX.lineWidth=2,hX.strokeRect(0,hueMarkerY-2,hC.width,4)}function drawSv(){sX.clearRect(0,0,sC.width,sC.height),sX.fillStyle=`hsl(${state.h*360}, 100%, 50%)`,sX.fillRect(0,0,sC.width,sC.height);const g=sX.createLinearGradient(0,0,sC.width,0);g.addColorStop(0,'rgba(255,255,255,1)'),g.addColorStop(1,'rgba(255,255,255,0)'),sX.fillStyle=g,sX.fillRect(0,0,sC.width,sC.height);const v=sX.createLinearGradient(0,0,0,sC.height);v.addColorStop(0,'rgba(0,0,0,0)'),v.addColorStop(1,'rgba(0,0,0,1)'),sX.fillStyle=v,sX.fillRect(0,0,sC.width,sC.height),sX.strokeStyle='white',sX.lineWidth=1,sX.beginPath(),sX.arc(svMarkerPos.x,svMarkerPos.y,5,0,2*Math.PI),sX.stroke(),sX.strokeStyle='black',sX.beginPath(),sX.arc(svMarkerPos.x,svMarkerPos.y,6,0,2*Math.PI),sX.stroke()}function update(){const{r,g,b}=hsvToRgb(state.h,state.s,state.v),h=rgbToHex(r,g,b);return pE.style.backgroundColor=h,hI.value=h,drawSv(),h}function fromHex(h){const r=hexToRgb(h);if(r){const c=rgbToHsv(r.r,r.g,r.b);state=c,svMarkerPos={x:state.s*sC.width,y:(1-state.v)*sC.height},hueMarkerY=state.h*hC.height,drawHue(),update()}}function svMove(e){e.preventDefault();const r=sC.getBoundingClientRect();let x=(e.clientX||e.touches[0].clientX)-r.left,y=(e.clientY||e.touches[0].clientY)-r.top;x=Math.max(0,Math.min(sC.width,x)),y=Math.max(0,Math.min(sC.height,y)),svMarkerPos={x,y},state.s=x/sC.width,state.v=1-y/sC.height,update()}function hueMove(e){e.preventDefault();const r=hC.getBoundingClientRect();let y=(e.clientY||e.touches[0].clientY)-r.top;y=Math.max(0,Math.min(hC.height,y)),hueMarkerY=y,state.h=y/hC.height,drawHue(),update()}const add=(h)=>{document.addEventListener('mousemove',h),document.addEventListener('touchmove',h,{passive:!1})},rem=(h)=>{document.removeEventListener('mousemove',h),document.removeEventListener('touchmove',h)},up=(h)=>{rem(h),document.removeEventListener('mouseup',up),document.removeEventListener('touchend',up)};sC.addEventListener('mousedown',e=>{svMove(e),add(svMove),document.addEventListener('mouseup',()=>up(svMove),{once:!0})}),sC.addEventListener('touchstart',e=>{svMove(e),add(svMove),document.addEventListener('touchend',()=>up(svMove),{once:!0})},{passive:!1}),hC.addEventListener('mousedown',e=>{hueMove(e),add(hueMove),document.addEventListener('mouseup',()=>up(hueMove),{once:!0})}),hC.addEventListener('touchstart',e=>{hueMove(e),add(hueMove),document.addEventListener('touchend',()=>up(hueMove),{once:!0})},{passive:!1}),hI.addEventListener('change',()=>fromHex(hI.value)),fromHex(initialHex),colorPickers[containerId]={getHex:()=>hI.value,setHex:fromHex}}
        const hexToRgb=(h)=>{let r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:null};
        const rgbToHex=(r,g,b)=>"#"+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');
        function rgbToHsv(r,g,b){r/=255,g/=255,b/=255;let max=Math.max(r,g,b),min=Math.min(r,g,b),h,s,v=max,d=max-min;s=max==0?0:d/max;if(max==min)h=0;else{switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4}h/=6}return{h,s,v}}
        function hsvToRgb(h,s,v){let r,g,b,i=Math.floor(h*6),f=h*6-i,p=v*(1-s),q=v*(1-f*s),t=v*(1-(1-f)*s);switch(i%6){case 0:r=v,g=t,b=p;break;case 1:r=q,g=v,b=p;break;case 2:r=p,g=v,b=t;break;case 3:r=p,g=q,b=v;break;case 4:r=t,g=p,b=v;break;case 5:r=v,g=p,b=q}return{r:Math.round(r*255),g:Math.round(g*255),b:Math.round(b*255)}}
        function generateThemePalette(a,b,c){const d=h=>{const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);return i?`${parseInt(i[1],16)},${parseInt(i[2],16)},${parseInt(i[3],16)}`:null},e=g=>{const h=parseInt(g.substring(1),16),i=h>>16&255,j=h>>8&255,k=h&255;return.2126*i+.7152*j+.0722*k},f=e(c)<128,g=(h,i)=>{let j=!1;if(h[0]=="#"){h=h.slice(1);j=!0}let k=parseInt(h,16),l=(k>>16)+i,m=(k>>8&255)+i,n=(k&255)+i;l=l>255?255:l<0?0:l;m=m>255?255:m<0?0:m;n=n>255?255:n<0?0:n;return(j?"#":"")+((l<<16)|m<<8|n).toString(16).padStart(6,'0')};return{'--bg-primary':c,'--bg-secondary':g(c,f?10:-10),'--bg-tertiary':g(c,f?20:-20),'--text-primary':f?'#eaeaea':'#111111','--text-secondary':f?'#a0a0a0':'#555555','--text-muted':f?'#666666':'#888888','--accent-primary':a,'--accent-secondary':b,'--border-color':g(c,f?30:-30),'--shadow':'0 8px 32px rgba(0,0,0,0.4)','--accent-glow':`rgba(${d(a)}, 0.2)`}}
        
        // --- NEW VISUALIZER CLASS ---
        class CyberpunkVisualizer { constructor(container){this.container=container;this.scene=null;this.camera=null;this.renderer=null;this.audioContext=null;this.analyser=null;this.dataArray=null;this.source=null;this.bars=[];this.centerSphere=null;this.particles=[];this.time=0;this.smoothedData=new Array(128).fill(0);this.targetCameraZ=100;this.currentCameraZ=100;this.mouse={x:0,y:0};this.targetRotation={x:0,y:0};this.currentRotation={x:0,y:0};this.init()}init(){this.scene=new THREE.Scene();this.camera=new THREE.PerspectiveCamera(75,this.container.clientWidth/this.container.clientHeight,0.1,1e3);this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0});this.renderer.setSize(this.container.clientWidth,this.container.clientHeight);this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));this.container.appendChild(this.renderer.domElement);this.camera.position.set(0,0,100);this.createCenterSphere();this.createCircularBars();this.createParticleSystem();this.setupLighting();this.setupControls();window.addEventListener("resize",()=>{this.camera.aspect=this.container.clientWidth/this.container.clientHeight;this.camera.updateProjectionMatrix();this.renderer.setSize(this.container.clientWidth,this.container.clientHeight)});this.animate()}getThemeColor(varName){return new THREE.Color(getComputedStyle(document.documentElement).getPropertyValue(varName).trim())}createCenterSphere(){const e=new THREE.SphereGeometry(6,32,32),t=new THREE.MeshPhongMaterial({color:this.getThemeColor("--accent-primary"),shininess:100,transparent:!0,opacity:.9,emissive:this.getThemeColor("--accent-secondary").multiplyScalar(.2)});this.centerSphere=new THREE.Mesh(e,t);this.scene.add(this.centerSphere)}createCircularBars(){const e=128,t=25;for(let i=0;i<e;i++){const s=(i/e)*Math.PI*2,r=Math.cos(s)*t,n=Math.sin(s)*t,o=new THREE.BoxGeometry(.6,1,.6),a=new THREE.MeshPhongMaterial({color:this.getThemeColor("--accent-primary"),transparent:!0,opacity:.8,emissive:this.getThemeColor("--accent-primary").multiplyScalar(.1)}),h=new THREE.Mesh(o,a);h.position.set(r,0,n);h.lookAt(0,0,0);this.bars.push({mesh:h,angle:s,basePosition:{x:r,z:n}});this.scene.add(h)}}createParticleSystem(){const e=100,t=new THREE.SphereGeometry(.2,6,6);for(let i=0;i<e;i++){const s=new THREE.MeshBasicMaterial({color:this.getThemeColor("--accent-secondary"),transparent:!0,opacity:.7}),r=new THREE.Mesh(t,s),n=35+Math.random()*50,o=Math.random()*Math.PI*2,a=(Math.random()-.5)*60;r.position.set(Math.cos(o)*n,a,Math.sin(o)*n);this.particles.push({mesh:r,baseY:a,baseRadius:n,angle:o,speed:.005+Math.random()*.01,phase:Math.random()*Math.PI*2});this.scene.add(r)}}setupLighting(){const e=new THREE.AmbientLight(this.getThemeColor("--bg-tertiary"),.5);this.scene.add(e);const t=new THREE.PointLight(this.getThemeColor("--accent-primary"),1,200);t.position.set(0,20,30);this.scene.add(t);const i=new THREE.PointLight(this.getThemeColor("--accent-secondary"),.8,200);i.position.set(30,-20,30);this.scene.add(i)}setupControls(){let e=!1,t=0,i=0;const s=(s,r)=>{e=!0,this.mouse.x=s/window.innerWidth*2-1,this.mouse.y=-(r/window.innerHeight)*2+1,t=s,i=r},r=(s,r)=>{if(!e)return;const n=s-t,o=r-i;this.targetRotation.y+=n*.01,this.targetRotation.x+=o*.01,t=s,i=r},n=()=>{e=!1};this.renderer.domElement.addEventListener("mousedown",e=>s(e.clientX,e.clientY)),document.addEventListener("mousemove",e=>r(e.clientX,e.clientY)),document.addEventListener("mouseup",n),this.renderer.domElement.addEventListener("touchstart",e=>{e.preventDefault();const t=e.touches[0];s(t.clientX,t.clientY)}),this.renderer.domElement.addEventListener("touchmove",e=>{e.preventDefault();const t=e.touches[0];r(t.clientX,t.clientY)}),this.renderer.domElement.addEventListener("touchend",e=>{e.preventDefault(),n()})}connectMicrophone(e){this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext));this.analyser=this.audioContext.createAnalyser();this.analyser.fftSize=256;this.analyser.smoothingTimeConstant=.8;const t=this.analyser.frequencyBinCount;this.dataArray=new Uint8Array(t);this.source=this.audioContext.createMediaStreamSource(e);this.source.connect(this.analyser)}disconnectMicrophone(){this.source&&this.source.disconnect(),this.source=null,this.analyser=null,this.dataArray=null}animate(){requestAnimationFrame(()=>this.animate());this.time+=.016;this.analyser&&this.analyser.getByteFrequencyData(this.dataArray);this.updateVisualizer();this.updateCamera();this.renderer.render(this.scene,this.camera)}updateVisualizer(){if(this.centerSphere.material.color.set(this.getThemeColor("--accent-primary")),this.centerSphere.material.emissive.set(this.getThemeColor("--accent-secondary").multiplyScalar(.2)),this.bars.forEach(e=>{e.mesh.material.color.set(this.getThemeColor("--accent-primary")),e.mesh.material.emissive.set(this.getThemeColor("--accent-primary").multiplyScalar(.1))}),this.particles.forEach(e=>{e.mesh.material.color.set(this.getThemeColor("--accent-secondary"))}),!this.dataArray)return;for(let e=0;e<this.dataArray.length;e++)this.smoothedData[e]+=(this.dataArray[e]-this.smoothedData[e])*.3;const e=this.smoothedData.slice(0,10).reduce((e,t)=>e+t,0)/10,t=1+(e/255)*2;this.centerSphere.scale.setScalar(t);this.bars.forEach((t,i)=>{const s=Math.floor(i/this.bars.length*this.smoothedData.length),r=this.smoothedData[s]/255,n=1+r*15;t.mesh.scale.y+=.2*(n-t.mesh.scale.y)});this.particles.forEach((t,i)=>{const s=Math.floor(i/this.particles.length*this.smoothedData.length),r=this.smoothedData[s]/255;t.angle+=t.speed*(1+r*2),t.phase+=.02;const n=t.baseRadius+Math.sin(t.phase)*10+r*20,o=t.baseY+Math.sin(t.phase*.7)*15+r*25;t.mesh.position.x=Math.cos(t.angle)*n,t.mesh.position.z=Math.sin(t.angle)*n,t.mesh.position.y=o,t.mesh.material.opacity=.4+r*.6})}updateCamera(){this.currentRotation.x+=(this.targetRotation.x-this.currentRotation.x)*.1,this.currentRotation.y+=(this.targetRotation.y-this.currentRotation.y)*.1;const e=this.currentCameraZ,t=Math.sin(this.currentRotation.y)*e,i=Math.cos(this.currentRotation.y)*e,s=Math.sin(this.currentRotation.x)*e*.5;this.camera.position.set(t,s,i),this.camera.lookAt(0,0,0)}}
    </script>
</body>
</html>